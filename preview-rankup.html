<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RankUp Preview — Award Ceremony</title>

  <style>
    body{
      margin:0;
      background: radial-gradient(circle at top, #0b0f1a, #05070d);
      color:#e5e7eb;
      font-family: Segoe UI, system-ui, sans-serif;
      padding: 24px;
    }

    .controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 18px;
    }

    .btn{
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(34,211,238,0.35);
      background: rgba(34,211,238,0.14);
      color:#a5f3fc;
      cursor:pointer;
      font-weight: 700;
      letter-spacing: .3px;
    }
    .btn:hover{ background: rgba(34,211,238,0.22); }

    .btn.ghost{
      border-color: rgba(251,113,133,0.35);
      background: rgba(251,113,133,0.10);
      color:#fecdd3;
    }
    .btn.ghost:hover{ background: rgba(251,113,133,0.16); }

    .note{ color:#9ca3af; font-size:12px; }

    /* =========================
       AWARD CEREMONY MODE (APEX-style)
       Phases: open -> impact -> reveal -> done -> auto-close
       No rift, no old/new swap
       ========================= */

    :root{
      --ru-ink:#EAF2FF;
      --ru-muted:#98A2B3;
      --ru-c1:#23f3ff;
      --ru-c2:#a855ff;
      --ru-c3:#ff3df2;
    }

    .rankup{
      position:fixed; inset:0; z-index:9999;
      display:grid; place-items:center;
      opacity:0; pointer-events:none;
      transition: opacity .22s ease;
    }
    .rankup.is-open{ opacity:1; pointer-events:auto; }

    /* Phase 0: veil */
    .rankup__veil{
      position:absolute; inset:0;
      background: radial-gradient(900px 520px at 50% 40%, rgba(0,0,0,.35), rgba(0,0,0,.92));
      opacity:0;
      transition: opacity .35s ease;
    }
    .rankup.is-open .rankup__veil{ opacity:1; }

    .rankup__grain{
      position:absolute; inset:-20%;
      opacity:.10;
      pointer-events:none;
      mix-blend-mode:overlay;
    }

    .rankup__stage{
      position:relative;
      width:min(980px, 92vw);
      height:min(520px, 76vh);
      border-radius:26px;
      overflow:hidden;
      background:
        radial-gradient(900px 520px at 50% 45%, rgba(35,243,255,.06), rgba(0,0,0,0) 60%),
        radial-gradient(900px 520px at 50% 55%, rgba(168,85,255,.05), rgba(0,0,0,0) 65%),
        rgba(7,10,18,0.55);
      border:1px solid rgba(255,255,255,0.05);
      box-shadow: 0 70px 200px rgba(0,0,0,0.78);
      transform: translateY(14px) scale(.98);
      opacity:0;
      will-change: transform, opacity;
    }
    .rankup.is-open .rankup__stage{
      animation: ruStageIn .45s cubic-bezier(.2,.9,.2,1) .05s forwards;
    }
    @keyframes ruStageIn{ to{ opacity:1; transform: translateY(0) scale(1); } }

    /* subtle scanlines */
    .rankup__scan{
      position:absolute; inset:0;
      background: repeating-linear-gradient(180deg, rgba(234,242,255,.06) 0, rgba(234,242,255,.06) 1px, transparent 1px, transparent 11px);
      opacity:.10;
      mix-blend-mode:overlay;
      animation: ruScanMove 3.2s linear infinite;
      pointer-events:none;
    }
    @keyframes ruScanMove{ to{ background-position: 0 140px; } }

    /* impact flash */
    .rankup__flash{
      position:absolute; inset:0;
      background:
        radial-gradient(closest-side at 50% 45%, rgba(255,255,255,.48), transparent 60%),
        radial-gradient(closest-side at 50% 55%, rgba(35,243,255,.24), transparent 70%),
        radial-gradient(closest-side at 50% 55%, rgba(168,85,255,.20), transparent 75%);
      opacity:0;
      mix-blend-mode:screen;
      pointer-events:none;
      will-change: opacity;
    }

    /* HUD */
    .rankup__hud{
      position:absolute; left:24px; right:24px; top:20px;
      display:flex; justify-content:space-between;
      pointer-events:none;
      opacity:.92;
      z-index: 6;
    }
    .rankup__kicker{
      font-size:14px; letter-spacing:.22em; text-transform:uppercase;
      color:rgba(234,242,255,.85);
    }
    .rankup__sub{ margin-top:8px; font-size:12px; color:rgba(152,162,179,.9); letter-spacing:.06em; }
    .rankup__hudRight{ font-size:12px; color:rgba(234,242,255,.72); letter-spacing:.1em; text-transform:uppercase; }

    /* NEW emblem only */
    .rankup__emblems{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:5; }
    .rankup__emblem{
      width:260px; height:260px;
      border-radius:26px;
      display:grid; place-items:center;
      position:absolute;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(234,242,255,.10);
      will-change: transform, opacity, filter;
    }
    .rankup__badge{
      width:190px; height:190px;
      border-radius:22px;
      display:grid; place-items:center;
      position:relative;
      background: rgba(0,0,0,0.10);
    }
    .rankup__img{ width:150px; height:150px; object-fit:contain; pointer-events:none; }

    .rankup__label{
      position:absolute;
      bottom:-34px;
      font-weight:900;
      letter-spacing:.18em;
      font-size:14px;
      text-transform:uppercase;
      color: rgba(234,242,255,.92);
      text-shadow: 0 0 16px rgba(35,243,255,.18);
    }

    /* Tier dots */
    .tierDots{
      position:absolute;
      left:50%;
      top: calc(50% + 160px);
      transform: translateX(-50%);
      display:flex;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(234,242,255,.12);
      background: rgba(0,0,0,.18);
      opacity:0;
      pointer-events:none;
    }
    .tierDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(234,242,255,.12);
    }
    .tierDot.is-on{
      background: rgba(35,243,255,.65);
      box-shadow: 0 0 10px rgba(35,243,255,.35), 0 0 22px rgba(168,85,255,.18);
    }
    .tierDot.is-justOn{
      animation: tdPing .7s cubic-bezier(.2,.95,.2,1) forwards;
    }
    @keyframes tdPing{
      0%{ transform: translateY(0) scale(.9); box-shadow: none; }
      40%{ transform: translateY(-2px) scale(1.35);
           box-shadow: 0 0 12px rgba(35,243,255,.55), 0 0 26px rgba(168,85,255,.22); }
      100%{ transform: translateY(0) scale(1);
            box-shadow: 0 0 10px rgba(35,243,255,.35), 0 0 22px rgba(168,85,255,.18); }
    }

    /* EVO layers */
    .evoHalo, .evoSigil{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%) scale(.92);
      width: min(520px, 78vmin);
      height: min(520px, 78vmin);
      border-radius: 999px;
      pointer-events:none;
      opacity:0;
      will-change: transform, opacity;
      mix-blend-mode: screen;
      z-index: 3;
    }
    .evoHalo{
      background:
        radial-gradient(closest-side, rgba(35,243,255,.12), transparent 62%),
        radial-gradient(closest-side, rgba(168,85,255,.10), transparent 68%),
        conic-gradient(from 0deg,
          rgba(35,243,255,0) 0deg,
          rgba(35,243,255,.22) 30deg,
          rgba(168,85,255,0) 95deg,
          rgba(255,61,242,.18) 140deg,
          rgba(35,243,255,0) 220deg,
          rgba(168,85,255,.16) 280deg,
          rgba(35,243,255,0) 360deg
        );
      filter: blur(10px);
    }
    .evoSigil{
      background:
        radial-gradient(circle at 50% 50%, transparent 56%, rgba(234,242,255,.14) 57%, transparent 58%),
        radial-gradient(circle at 50% 50%, transparent 66%, rgba(35,243,255,.18) 67%, transparent 68%),
        repeating-conic-gradient(from 0deg,
          rgba(35,243,255,0) 0 10deg,
          rgba(35,243,255,.18) 10deg 12deg,
          rgba(35,243,255,0) 12deg 28deg
        );
      opacity:0;
      filter: blur(.2px);
    }

    .evoStamp{
      position:absolute;
      left:50%;
      top: calc(50% + 200px);
      transform: translateX(-50%) translateY(10px);
      text-align:center;
      pointer-events:none;
      opacity:0;
      will-change: transform, opacity;
      z-index: 6;
    }
    .evoStamp__top{
      font-size:12px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color: rgba(234,242,255,.82);
    }
    .evoStamp__name{
      margin-top:8px;
      font-size:26px;
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(234,242,255,.92);
      text-shadow: 0 0 16px rgba(35,243,255,.22), 0 0 30px rgba(168,85,255,.18);
    }

    /* CTA (hidden in this preview – auto close) */
    .rankup__cta{ display:none; }

    /* ===== Phase direction ===== */

    /* OPEN: charge (badge stays still) */
    #rankup.is-rankup[data-phase="open"] .evoHalo{
      animation: awardHaloCharge .9s ease forwards;
    }
    @keyframes awardHaloCharge{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.92); }
      100%{ opacity:.28; transform: translate(-50%,-50%) scale(1.02); }
    }

    /* IMPACT: single expensive hit */
    #rankup.is-rankup[data-phase="impact"] .rankup__flash{ animation: awardFlash 220ms ease forwards; }
    @keyframes awardFlash{ 0%{opacity:0;} 25%{opacity:1;} 100%{opacity:0;} }

    #rankup.is-rankup[data-phase="impact"] .rankup__stage{ animation: awardHit 260ms cubic-bezier(.12,.92,.18,1) forwards; }
    @keyframes awardHit{
      0%{ transform: translateY(0) scale(1); }
      45%{ transform: translateY(-1px) scale(1.02); }
      100%{ transform: translateY(0) scale(1); }
    }

    #rankup.is-rankup[data-phase="impact"] .evoHalo{ animation: awardHaloImpact .45s ease forwards; }
    #rankup.is-rankup[data-phase="impact"] .evoSigil{ animation: awardSigilImpact .45s ease forwards; }
    @keyframes awardHaloImpact{
      0%{ opacity:.28; transform: translate(-50%,-50%) scale(1.02); }
      40%{ opacity:1; transform: translate(-50%,-50%) scale(1.18) rotate(8deg); }
      100%{ opacity:.38; transform: translate(-50%,-50%) scale(1.06) rotate(0deg); }
    }
    @keyframes awardSigilImpact{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.96); }
      40%{ opacity:.85; transform: translate(-50%,-50%) scale(1.04); }
      100%{ opacity:.18; transform: translate(-50%,-50%) scale(1.02); }
    }

    /* REVEAL: evolution badge (0.86 -> 1.08 -> 1.00) */
    #rankup.is-rankup[data-phase="reveal"] #rankupNew{
      animation: awardBadgeEvo 1.25s cubic-bezier(.12,.95,.18,1) forwards;
    }
    @keyframes awardBadgeEvo{
      0%{ transform: translateY(0) scale(.86); }
      55%{ transform: translateY(0) scale(1.08); }
      100%{ transform: translateY(0) scale(1); }
    }

    #rankup.is-rankup[data-phase="reveal"] .evoStamp{
      animation: awardStampIn .75s cubic-bezier(.2,.9,.2,1) .10s forwards;
    }
    @keyframes awardStampIn{
      0%{ opacity:0; transform: translateX(-50%) translateY(14px); }
      100%{ opacity:1; transform: translateX(-50%) translateY(0); }
    }

    /* DONE: stabilize + breathe */
    #rankup.is-rankup[data-phase="done"] .rankup__badge{
      animation: awardBreathe 2.2s ease-in-out infinite;
    }
    @keyframes awardBreathe{
      0%,100%{ box-shadow: 0 0 18px rgba(168,85,255,.28), 0 0 48px rgba(35,243,255,.16); }
      50%{ box-shadow: 0 0 26px rgba(168,85,255,.42), 0 0 70px rgba(35,243,255,.24); }
    }

    #rankup.is-rankup[data-phase="done"] .tierDots{ opacity:1; }
    #rankup[data-top="1"] .tierDots{ display:none !important; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .evoHalo,.evoSigil,.evoStamp{ display:none !important; }
      .rankup__scan{ animation:none !important; }
    }
  </style>
</head>
<body>

  <div class="controls">
    <button class="btn" id="btnRankUp">Play RankUp (auto-close)</button>
    <button class="btn" id="btnTierUp">Play TierUp</button>
    <button class="btn ghost" id="btnHide">Hide</button>
    <span class="note">Award Ceremony preview — no rift, no swap, web-safe.</span>
  </div>

  <!-- ===== RANKUP OVERLAY (Award Ceremony) ===== -->
  <div class="rankup" id="rankup" aria-hidden="true" data-phase="idle" data-type="rank" data-top="0">
    <div class="rankup__veil"></div>
    <div class="rankup__grain" aria-hidden="true"></div>

    <div class="rankup__stage" role="dialog" aria-label="Rank up cinematic">
      <div class="rankup__scan" aria-hidden="true"></div>
      <div class="rankup__flash" aria-hidden="true"></div>

      <!-- Evolution FX layers -->
      <div class="evoHalo" aria-hidden="true"></div>
      <div class="evoSigil" aria-hidden="true"></div>

      <div class="evoStamp" aria-hidden="true">
        <div class="evoStamp__top">NEW RANK</div>
        <div class="evoStamp__name" id="evoRankName">EIDOLON</div>
      </div>

      <!-- Top HUD -->
      <header class="rankup__hud">
        <div class="rankup__hudLeft">
          <div class="rankup__kicker">RANKED UPDATE</div>
          <div class="rankup__sub" id="rankupSub">Award Ceremony • Preparing…</div>
        </div>
        <div class="rankup__hudRight" id="rankupRight">NEW RANK UNLOCKED</div>
      </header>

      <!-- Emblems (NEW only) -->
      <div class="rankup__emblems">
        <div class="rankup__emblem rankup__emblem--new is-award" id="rankupNew">
          <div class="rankup__badge rankup__badge--new">
            <img class="rankup__img" id="rankupNewImg" alt="New rank badge" />
            <span class="rankup__label" id="rankupNewLabel">EIDOLON</span>
          </div>

          <!-- Tier (Division) indicator: 3 segments -->
          <div class="tierDots" id="tierDots" aria-hidden="true">
            <span class="tierDot" data-i="0"></span>
            <span class="tierDot" data-i="1"></span>
            <span class="tierDot" data-i="2"></span>
          </div>
        </div>
      </div>

      <footer class="rankup__cta">
        <button class="rankup__btn" id="rankupContinue" type="button">Continue</button>
      </footer>
    </div>
  </div>

  <script>
    // =============================
    // SAFE API (Preview) — Award Ceremony
    // =============================

    function _ruGetRoot(){ return document.getElementById("rankup"); }

    function _ruSetPhase(root, phase){ root.dataset.phase = phase; }

    function _ruSetOpen(root, isOpen){
      root.classList.toggle("is-open", isOpen);
      root.setAttribute("aria-hidden", isOpen ? "false" : "true");
      if (!isOpen) { try { document.activeElement && document.activeElement.blur(); } catch(e) {} }
    }

    function _ruTierKeyFromText(t){
      return String(t || "").trim().split(" ")[0].toLowerCase();
    }

    function _ruIsTopRankText(toText){
      const t = String(toText || "").toUpperCase();
      return t.includes("EIDOLON");
    }

    var _ruTimers = [];
    function _ruLater(fn, ms){
      var id = setTimeout(fn, ms);
      _ruTimers.push(id);
      return id;
    }
    function _ruClearTimers(){
      while (_ruTimers.length) clearTimeout(_ruTimers.pop());
    }

    function _ruFill(payload){
      const root = _ruGetRoot();
      if (!root) return null;

      const subEl = document.getElementById("rankupSub");
      const rightEl = document.getElementById("rankupRight");
      const newLabelEl = document.getElementById("rankupNewLabel");
      const newImg = document.getElementById("rankupNewImg");
      const evoName = document.getElementById("evoRankName");

      const toText = payload?.toText || "";
      const rrText = payload?.rrText || "";

      if (subEl) subEl.textContent = payload?.subText || subEl.textContent;
      if (rightEl) rightEl.textContent = rrText;

      if (newLabelEl) newLabelEl.textContent = toText;
      if (evoName) evoName.textContent = String(toText).trim().split(" ")[0].toUpperCase();

      if (newImg) newImg.src = "assets/ranks/" + _ruTierKeyFromText(toText) + ".webp";
      if (newImg) newImg.onerror = function(){ newImg.removeAttribute("src"); };

      return { root, toText };
    }

    function _ruRunTimeline(root, steps){
      let i = 0;
      function next(){
        if (i >= steps.length) return;
        const s = steps[i++];
        _ruSetPhase(root, s.phase);
        if (s.ms != null) _ruLater(next, s.ms);
      }
      next();
    }

    window.hideRankUp = function(){
      _ruClearTimers();
      const root = _ruGetRoot();
      if (!root) return;
      root.classList.remove("is-rankup");
      _ruSetOpen(root, false);
      _ruSetPhase(root, "idle");
      const dotsWrap = document.getElementById("tierDots");
      if (dotsWrap) {
        const dots = dotsWrap.querySelectorAll(".tierDot");
        dots.forEach(d => d.classList.remove("is-on","is-justOn"));
      }
    };

    window.showRankUp = function(payload){
      window.hideRankUp();

      const res = _ruFill(payload);
      if (!res) return;

      const root = res.root;
      root.dataset.type = "rank";
      root.dataset.top = _ruIsTopRankText(res.toText) ? "1" : "0";
      root.classList.add("is-rankup");

      _ruSetOpen(root, true);

      // Award timeline (no collapse)
      const timeline = [
        { phase: "open", ms: 900 },
        { phase: "impact", ms: 260 },
        { phase: "reveal", ms: 1250 },
        { phase: "done", ms: null }
      ];

      _ruRunTimeline(root, timeline);

      // Auto-close after hold
      _ruLater(() => window.hideRankUp(), 900 + 260 + 1250 + 1400);
    };

    window.showTierUp = function(payload){
      window.hideRankUp();

      const root = _ruGetRoot();
      if (!root) return;

      root.dataset.type = "tier";
      root.dataset.top = "0";
      root.classList.remove("is-rankup");

      // Fill “to”
      _ruFill(payload);

      _ruSetOpen(root, true);

      // Dots
      const dotsWrap = document.getElementById("tierDots");
      if (dotsWrap) {
        const dots = dotsWrap.querySelectorAll(".tierDot");
        dots.forEach(d => d.classList.remove("is-on","is-justOn"));

        const di = (payload && payload.divIndex != null) ? Number(payload.divIndex) : 0;
        const onCount = Math.max(0, Math.min(3, di + 1));
        for (let i=0;i<onCount;i++) dots[i].classList.add("is-on");

        // ping
        const justOnIndex = Math.max(0, Math.min(2, di));
        dots[justOnIndex].classList.add("is-justOn");
        _ruLater(() => dots[justOnIndex].classList.remove("is-justOn"), 720);
      }

      const timeline = [
        { phase: "impact", ms: 220 },
        { phase: "reveal", ms: 550 },
        { phase: "done", ms: null }
      ];
      _ruRunTimeline(root, timeline);

      _ruLater(() => window.hideRankUp(), 1100);
    };

    // Preview controls
    document.getElementById("btnRankUp").addEventListener("click", () => {
      window.showRankUp({
        fromText: "OUTCAST I",
        toText: "THRALL III",
        rrText: "NEW RANK UNLOCKED"
      });
    });

    document.getElementById("btnTierUp").addEventListener("click", () => {
      window.showTierUp({
        fromText: "ARCHON III",
        toText: "ARCHON II",
        rrText: "TIER UPGRADED",
        divIndex: 1
      });
    });

    document.getElementById("btnHide").addEventListener("click", () => window.hideRankUp());

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") window.hideRankUp();
    });
  </script>

</body>
</html>
