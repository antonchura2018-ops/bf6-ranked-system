<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="../assets/css/theme_A.css">
<link rel="stylesheet" href="../assets/css/ui-kit.css">
<title>BF6 Ranked System</title>

<!-- ============================= -->
<!-- ===== GLOBAL STYLES (CSS) === -->
<!-- ============================= -->
<style>


  /* ====== FORM (ADD MATCH) ====== */
.form .grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  max-width: 620px;
}

.form label{
  display:flex;
  flex-direction:column;
  gap: 8px;
  font-size: 12px;
  color:#cbd5e1;
  letter-spacing: .3px;
}

.form input[type="number"]{
  padding: 12px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(2,6,23,0.55);
  color:#e5e7eb;
  outline: none;
}

.form input[type="number"]:focus{
  border-color: rgba(34,211,238,0.35);
  box-shadow: 0 0 18px rgba(34,211,238,0.08);
}

.toggles{
  margin-top: 14px;
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
}

.toggle{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(2,6,23,0.45);
  color:#e5e7eb;
  font-size: 12px;
}

.toggle input{ transform: scale(1.1); }

.actions{
  margin-top: 16px;
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}

.btn{
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid rgba(34,211,238,0.35);
  background: rgba(34,211,238,0.14);
  color:#a5f3fc;
  cursor:pointer;
  font-weight: 700;
  letter-spacing: .3px;
}

.btn:hover{
  background: rgba(34,211,238,0.22);
}

.btn.ghost{
  border-color: rgba(251,113,133,0.35);
  background: rgba(251,113,133,0.10);
  color:#fecdd3;
}

.btn.ghost:hover{
  background: rgba(251,113,133,0.16);
}

.hint{
  font-size: 12px;
  color:#9ca3af;
  opacity: .9;
}

  /* ====== MATCH HISTORY UI ====== */
.history-top{
  margin-top: 22px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 900px;
}
  .season-summary{
  margin-top: 14px;
  max-width: 1100px;
  background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(2,6,23,.9));
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 14px;
  padding: 14px 16px;
  box-shadow: 0 0 24px rgba(34,211,238,0.05);
}

.season-summary .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.season-summary .row:last-child{ border-bottom:none; }

.season-summary .k{
  color:#9ca3af;
  font-size: 12px;
  letter-spacing: .4px;
}

.season-summary .v{
  color:#e5e7eb;
  font-weight: 800;
  font-size: 12px;
  letter-spacing: .4px;
}

.season-tag{
  display:inline-block;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(2,6,23,0.55);
  font-size: 11px;
  color:#cbd5e1;
}
.season-tag.active{
  border-color: rgba(34,211,238,0.30);
  color:#a5f3fc;
}
  .history-controls{
  margin-top: 16px;
  max-width: 900px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
}
  .season-select{
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(2,6,23,0.55);
  color:#e5e7eb;
  outline:none;
  font-size: 12px;
}
  .ro-badge{
  display:inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.78);
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .12em;
}
  
.season-select:focus{
  border-color: rgba(34,211,238,0.35);
  box-shadow: 0 0 18px rgba(34,211,238,0.08);
}

.mini-card{
  padding: 14px 16px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(2,6,23,.9));
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 0 24px rgba(34,211,238,0.05);
}

.mini-label{
  font-size: 12px;
  color:#9ca3af;
  letter-spacing: .8px;
}

.mini-value{
  margin-top: 6px;
  font-size: 22px;
  font-weight: 800;
  color:#22d3ee;
  text-shadow: 0 0 10px rgba(34,211,238,0.25);
}

.match-list{
  margin-top: 16px;
  display: grid;
  gap: 12px;
  max-width: 900px;
}

.match-card{
  position: relative;
  padding: 16px 16px;
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(2,6,23,.85), rgba(15,23,42,.85));
  border: 1px solid rgba(255,255,255,0.06);
  overflow: hidden;
  transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
}

.match-card:hover{
  transform: translateY(-1px);
  border-color: rgba(34,211,238,0.18);
  box-shadow: 0 0 28px rgba(34,211,238,0.06);
}

.match-card.best{
  border-color: rgba(34,211,238,0.55);
  box-shadow: 0 0 34px rgba(34,211,238,0.10);
}

.match-card.worst{
  border-color: rgba(251,113,133,0.45);
  box-shadow: 0 0 34px rgba(251,113,133,0.08);
}

.match-row{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.left{
  display:flex;
  flex-direction: column;
  gap: 6px;
}

.title{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight: 800;
  letter-spacing: .8px;
}

.place{
  font-size: 12px;
  color:#9ca3af;
}

.kad{
  font-size: 12px;
  color:#9ca3af;
}
  .breakdown{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.06);
  background: rgba(2,6,23,0.42);
}

.break-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  font-size: 12px;
  color:#9ca3af;
  padding: 2px 0;
}

.break-row strong{
  color:#e5e7eb;
  font-weight: 800;
}

.break-row .pos{ color: #22c55e; }
.break-row .neg{ color: #fb7185; }

.break-total{
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid rgba(255,255,255,0.06);
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size: 12px;
  letter-spacing: .4px;
}

.break-total span{
  color:#cbd5e1;
  font-weight: 800;
}

.rpDelta{
  font-size: 18px;
  font-weight: 900;
  min-width: 90px;
  text-align: right;
}
  .match-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:10px;
}

.btn-mini{
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.85);
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
}

.btn-mini:hover{
  background: rgba(255,255,255,0.10);
  border-color: rgba(255,255,255,0.18);
}

.btn-mini.danger{
  border-color: rgba(251,113,133,0.35);
  background: rgba(251,113,133,0.10);
  color:#fecdd3;
}
.btn-mini.danger:hover{
  background: rgba(251,113,133,0.16);
}

.rpPlus{ color:#22c55e; text-shadow: 0 0 12px rgba(34,197,94,0.15); }
.rpMinus{ color:#fb7185; text-shadow: 0 0 12px rgba(251,113,133,0.15); }

.badges{
  display:flex;
  gap:8px;
  flex-wrap: wrap;
}

.badge-pill{
  font-size: 11px;
  letter-spacing: .6px;
  padding: 5px 9px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(2,6,23,0.55);
  color:#e5e7eb;
  opacity: .95;
}

.badge-mvp{
  border-color: rgba(251,191,36,0.35);
  box-shadow: 0 0 14px rgba(251,191,36,0.10);
  color:#fbbf24;
}

.badge-leave{
  border-color: rgba(251,113,133,0.35);
  box-shadow: 0 0 14px rgba(251,113,133,0.10);
  color:#fb7185;
}

  /* ====== RANK LADDER ====== */
.ladder{
  margin-top: 28px;
  max-width: 1100px;
  margin: 28px auto 0;
}

.ladder-head{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  margin-bottom: 12px;
}

.ladder-head h3{
  font-size: 18px;
  letter-spacing: .6px;
  color:#e5e7eb;
}

.ladder-note{
  font-size: 12px;
  color:#9ca3af;
  opacity:.9;
}

.ladder-list{
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

.ladder-item{
  position:relative;
  display:flex;
  gap: 14px;
  align-items:center;
  padding: 14px 16px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(2,6,23,.9));
  border: 1px solid rgba(255,255,255,0.06);
  overflow:hidden;
  transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
}

.ladder-item:hover{
  transform: translateY(-1px);
  border-color: rgba(34,211,238,0.18);
  box-shadow: 0 0 26px rgba(34,211,238,0.06);
}

.ladder-item.locked{
  opacity: .35;
  filter: grayscale(0.35);
}

.ladder-item.unlocked{
  opacity: 1;
}

.ladder-item.current{
  border-color: rgba(34,211,238,0.55);
  box-shadow: 0 0 34px rgba(34,211,238,0.10);
}

.ladder-item.current::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: 14px;
  padding: 2px;
  background: linear-gradient(120deg, rgba(34,211,238,0.95), rgba(56,189,248,0.0), rgba(34,211,238,0.75));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: .55;
  filter: drop-shadow(0 0 14px rgba(34,211,238,0.25));
  pointer-events:none;
}

.badge{
  width: 56px;
  height: 56px;
  border-radius: 16px;
  position:relative;
  overflow:hidden;
  box-shadow: 0 0 16px rgba(0,0,0,.35);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  background-color: transparent;
}
  /* Ladder badge states (images) */
.ladder-item.locked .badge{
  filter: grayscale(1) brightness(0.35);
  opacity: 0.35;
}

.ladder-item.unlocked .badge{
  filter: grayscale(0.15) brightness(0.9);
  opacity: 0.9;
}

.ladder-item.current .badge{
  filter: grayscale(0) brightness(1.05);
  opacity: 1;
}

.badge::before{
  content:"";
  position:absolute;
  inset:-16px;
  background: conic-gradient(from 0deg, rgba(255,255,255,0.0), rgba(255,255,255,0.55), rgba(255,255,255,0.0));
  opacity:.25;
  animation: spin 7s linear infinite;
}

.meta .name{
  font-size: 14px;
  letter-spacing: 1px;
  font-weight: 700;
  color:#e5e7eb;
}

.meta .desc{
  margin-top: 2px;
  font-size: 12px;
  color:#9ca3af;
}
  @media (max-width: 980px){
  .ladder-list{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 640px){
  .ladder-list{ grid-template-columns: 1fr; }
}

/* ====== BADGE COLORS (Neon identity) ====== */
.b-outcast   { background: radial-gradient(circle at 30% 30%, #ffb86b, #111827 55%, #020617 85%); box-shadow: 0 0 18px rgba(255,146,76,.35); }
.b-vanguard  { background: radial-gradient(circle at 30% 30%, #22d3ee, #0b1220 55%, #020617 85%); box-shadow: 0 0 18px rgba(34,211,238,.35); }
.b-sentinel  { background: radial-gradient(circle at 30% 30%, #38bdf8, #0b1220 55%, #020617 85%); box-shadow: 0 0 18px rgba(56,189,248,.35); }
.b-phantom   { background: radial-gradient(circle at 30% 30%, #a78bfa, #111827 55%, #020617 85%); box-shadow: 0 0 18px rgba(167,139,250,.35); }
.b-warlord   { background: radial-gradient(circle at 30% 30%, #fb7185, #111827 55%, #020617 85%); box-shadow: 0 0 18px rgba(251,113,133,.35); }
.b-archon    { background: radial-gradient(circle at 30% 30%, #fbbf24, #111827 55%, #020617 85%); box-shadow: 0 0 18px rgba(251,191,36,.35); }
.b-overseer  { background: radial-gradient(circle at 30% 30%, #2dd4bf, #0b1220 55%, #020617 85%); box-shadow: 0 0 18px rgba(45,212,191,.35); }
.b-ascendant { background: radial-gradient(circle at 30% 30%, #60a5fa, #0b1220 55%, #020617 85%); box-shadow: 0 0 18px rgba(96,165,250,.35); }
.b-paragon   { background: radial-gradient(circle at 30% 30%, #e5e7eb, #111827 55%, #020617 85%); box-shadow: 0 0 18px rgba(229,231,235,.25); }
.b-nexus     { background: radial-gradient(circle at 30% 30%, #ff3b3b, #0b0f1a 55%, #020617 85%); box-shadow: 0 0 22px rgba(255,59,59,.40); }

.ladder-item.nexus{
  border-color: rgba(255,59,59,0.25);
}

/* ====== GLOBAL ====== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', sans-serif;
}

body {
  background: radial-gradient(circle at top, #0b0f1a, #05070d);
  color: #e5e7eb;
  min-height: 100vh;
}

/* ====== NAV BAR ====== */
.navbar {
  display: flex;
  justify-content: center;
  gap: 30px;
  padding: 20px;
  background: linear-gradient(180deg, #0f172a, #020617);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.nav-btn {
  background: transparent;
  border: none;
  color: #9ca3af;
  font-size: 15px;
  letter-spacing: 1px;
  cursor: pointer;
  padding: 10px 20px;
  position: relative;
  transition: color 0.3s;
}

.nav-btn:hover { color: #38bdf8; }
.nav-btn.active { color: #22d3ee; }

.nav-btn.active::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 50%;
  transform: translateX(-50%);
  width: 40%;
  height: 2px;
  background: linear-gradient(90deg, #22d3ee, #38bdf8);
  box-shadow: 0 0 12px #22d3ee;
}

/* ====== CONTENT ====== */
.section {
  display: none;
  padding: 50px;
  animation: fade 0.4s ease;
  max-width: 1200px;
  margin: 0 auto;
}
.section.active { display: block; }

@keyframes fade {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ====== HEADERS ====== */
h1 {
  font-size: 32px;
  margin-bottom: 10px;
  background: linear-gradient(90deg, #22d3ee, #38bdf8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

p { color: #9ca3af; }

/* ====== PANELS ====== */
.panel {
  margin-top: 30px;
  background: linear-gradient(180deg, #0f172a, #020617);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 14px;
  padding: 25px;
  box-shadow: 0 0 25px rgba(34,211,238,0.05);
}

/* ====== RANK CARD (BASE) ====== */
.rank-card {
  margin-top: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 18px;
  padding: 40px 28px;
  background: linear-gradient(135deg, #020617, #0f172a);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 0 40px rgba(56,189,248,0.15);
  width: 100%;
max-width: 1100px;
margin: 32px auto 20px;

  position: relative;
  overflow: hidden;
  transition: transform 0.25s ease;
}

.rank-card:hover { transform: translateY(-2px); }

.rank-icon {
  width: 260px;
  height: 260px;
  border-radius: 50%;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 25px color-mix(in srgb, var(--rank-accent, #22d3ee) 75%, transparent);
  background: transparent;
}
  .rank-icon img{
  position: absolute;
  inset: 10px;
  width: calc(100% - 20px);
  height: calc(100% - 20px);
  object-fit: contain;
  z-index: 2;
  pointer-events: none;
  filter: drop-shadow(0 0 18px rgba(255,255,255,0.35));
}

.rank-glow {
  position: absolute;
  inset: -20px;
  background: conic-gradient(from 0deg, transparent, #38bdf8, transparent);
  animation: spin 6s linear infinite;
  z-index: 1;
  pointer-events: none;
}

@keyframes spin { to { transform: rotate(360deg); } }

.rank-info h2 {
  font-size: 44px;
  letter-spacing: 1.2px;
  margin-bottom: 8px;
  background: linear-gradient(90deg, #38bdf8, #22d3ee);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.rank-rp { font-size: 16px; color: #cbd5e1; }

/* ====== RP BAR ====== */
.rp-bar {
  margin: 14px auto 0;
  width: min(520px, 92vw);
  height: 12px;
  background: #020617;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.08);
}

.rp-fill {
  height: 100%;
  background: linear-gradient(90deg, #22d3ee, #38bdf8, #0ea5e9);
  box-shadow: 0 0 12px #38bdf8;
  transition: width 0.5s ease;
}

/* ====== CHIP ====== */
.chip{
  display:inline-block;
  margin-top:10px;
  padding:6px 10px;
  font-size:12px;
  letter-spacing:1px;
  color:#a5f3fc;
  border:1px solid rgba(34,211,238,0.35);
  border-radius:999px;
  background: rgba(2,6,23,0.55);
  box-shadow: 0 0 14px rgba(34,211,238,0.15);
}

/* ====== RANK CARD GAME FX ====== */
.rank-bg {
  position: absolute;
  inset: -40px;
  background:
    radial-gradient(circle at 20% 30%, rgba(34,211,238,0.25), transparent 55%),
    radial-gradient(circle at 80% 70%, rgba(56,189,248,0.18), transparent 60%),
    radial-gradient(circle at 50% 50%, rgba(14,165,233,0.12), transparent 65%);
  filter: blur(12px);
  animation: bgFloat 8s ease-in-out infinite;
  z-index: 0;
}

@keyframes bgFloat {
  0% { transform: translate(0,0) scale(1); }
  50% { transform: translate(12px,-8px) scale(1.03); }
  100% { transform: translate(0,0) scale(1); }
}

.rank-noise {
  position: absolute;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
  opacity: 0.12;
  mix-blend-mode: overlay;
  z-index: 1;
}

.rank-card::after {
  content: "";
  position: absolute;
  inset: -2px;
  border-radius: 18px;
  padding: 2px;
  background: linear-gradient(120deg, rgba(34,211,238,0.9), rgba(56,189,248,0.0), rgba(34,211,238,0.7));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0.55;
  filter: drop-shadow(0 0 18px rgba(34,211,238,0.35));
  animation: edgePulse 3.2s ease-in-out infinite;
  z-index: 2;
}

@keyframes edgePulse {
  0%, 100% { opacity: 0.35; }
  50% { opacity: 0.75; }
}

/* make inner content above effects */
.rank-icon, .rank-info { position: relative; z-index: 3; }

.rank-icon::before {
  content: "";
  position: absolute;
  inset: -18px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(34,211,238,0.35), transparent 65%);
  filter: blur(10px);
  opacity: 0.9;
}

.rank-icon::after {
  content: "";
  position: absolute;
  inset: 10px;
  border-radius: 50%;
  background: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.35), transparent 55%);
  opacity: 0.7;
}
  
  #award{
      position:fixed; inset:0; z-index:9999;
      display:grid; place-items:center;
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    #award.is-open{ opacity:1; pointer-events:auto; }

    .veil{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 50% 42%,
          color-mix(in srgb, var(--accent) 18%, transparent),
          rgba(0,0,0,.88)
        ),
        radial-gradient(1200px 720px at 50% 10%,
          color-mix(in srgb, var(--accent) 10%, transparent),
          transparent 60%
        ),
        linear-gradient(180deg, rgba(0,0,0,.78), rgba(0,0,0,.92));
      opacity:0;
    }
    #award.is-open .veil{ animation: veilIn .26s ease forwards; }
    @keyframes veilIn{ to{ opacity:1; } }

    /* Minimal HUD (optional) */
    .hud{
      position:absolute; left:34px; right:34px; top:22px;
      display:flex; justify-content:space-between; gap:14px;
      pointer-events:none;
      opacity:.92;
    }
    .hud .left .kicker{
      font-size:12px; letter-spacing:.22em; text-transform:uppercase;
      color: rgba(234,242,255,.78);
    }
    .hud .left .sub{
      margin-top:8px;
      font-size:12px;
      color: rgba(152,162,179,.9);
      letter-spacing:.06em;
      max-width:560px;
    }
    .hud .right{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(234,242,255,.66);
    }

    /* Center */
    .center{
      position:relative;
      width: min(920px, 96vw);
      height: min(820px, 86vh);
      display:grid;
      place-items:center;
      pointer-events:none;
      will-change: transform;
    }

    /* Backlight (NO blur) */
    .center::before{
      content:"";
      position:absolute;
      inset:-95%;
      background: radial-gradient(circle at 50% 50%,
        color-mix(in srgb, var(--accent) 18%, transparent),
        transparent 64%
      );
      opacity:1;
      filter:none;
      pointer-events:none;
    }

    /* Stack = badge + label centered together */
    .stack{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 22px;
    }
  
    #award .hud .left{ display:none !important; }
  
    /* =========================================================
       FX LAYERS (FPS-SAFE): opacity + transform only
       ========================================================= */

    .impactFlash{
      position:absolute; inset:-30%;
      background:
        radial-gradient(closest-side at 50% 50%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(closest-side at 50% 50%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 72%);
      opacity:0;
      transform: scale(.78);
      pointer-events:none;
      will-change: opacity, transform;
    }
    #award[data-phase="impact"] .impactFlash{
      animation: flash 520ms ease forwards;
    }
    @keyframes flash{
      0%{ opacity:0; transform: scale(.78); }
      35%{ opacity:1; transform: scale(1); }
      100%{ opacity:0; transform: scale(1.12); }
    }

    /* Core flash (Apex-like) */
    .coreFlash{
      position:absolute;
      width: 22vmin;
      height: 22vmin;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      background: radial-gradient(circle,
        rgba(255,255,255,.20),
        color-mix(in srgb, var(--accent) 22%, transparent),
        transparent 70%
      );
      transform: scale(.6);
      will-change: transform, opacity;
    }
    #award[data-phase="impact"] .coreFlash{
      animation: corePop 360ms ease forwards;
    }
    @keyframes corePop{
      0%{opacity:0; transform: scale(.55);}
      35%{opacity:1; transform: scale(1.05);}
      100%{opacity:0; transform: scale(1.35);}
    }

    /* Creation glow burst */
    .creationGlow{
      position:absolute;
      inset:-140%;
      border-radius:999px;
      pointer-events:none;
      opacity:0;
      transform: scale(.18);
      will-change: transform, opacity;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.12) 0%,
          color-mix(in srgb, var(--accent) 22%, transparent) 20%,
          color-mix(in srgb, var(--accent) 12%, transparent) 40%,
          transparent 64%
        );
    }
    #award[data-phase="reveal"] .creationGlow{
      animation: cgPop 1150ms cubic-bezier(.12,.95,.18,1) forwards;
    }
    @keyframes cgPop{
      0%   { opacity:0; transform: scale(.18); }
      18%  { opacity:1; transform: scale(.52); }
      100% { opacity:0; transform: scale(1.55); }
    }

    /* Wing creation: two side glows expanding outward */
    .wingWave{
      position:absolute;
      inset:-110%;
      border-radius:999px;
      pointer-events:none;
      opacity:0;
      transform: scale(.55);
      will-change: transform, opacity;
      background:
        radial-gradient(circle at 18% 52%,
          color-mix(in srgb, var(--accent) 40%, transparent) 0%,
          transparent 40%
        ),
        radial-gradient(circle at 82% 52%,
          color-mix(in srgb, var(--accent) 40%, transparent) 0%,
          transparent 40%
        );
    }
    #award[data-phase="reveal"] .wingWave{
      animation: wwPop 1050ms cubic-bezier(.12,.95,.18,1) forwards;
    }
    @keyframes wwPop{
      0%   { opacity:0; transform: scale(.52); }
      20%  { opacity:.95; transform: scale(.82); }
      100% { opacity:0; transform: scale(1.40); }
    }

    /* Sparks (no blur) */
    .sparks{
      position:absolute;
      inset:-35%;
      opacity:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 20% 30%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 38%),
        radial-gradient(circle at 70% 55%, color-mix(in srgb, var(--accent) 14%, transparent), transparent 40%),
        radial-gradient(circle at 55% 25%, rgba(255,255,255,.08), transparent 34%),
        radial-gradient(circle at 35% 70%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 42%);
      transform: scale(.98);
      will-change: opacity, transform;
    }
    #award[data-phase="open"] .sparks{ animation: sparksOpen 900ms ease forwards; }
    #award[data-phase="reveal"] .sparks{ animation: sparksReveal 1200ms ease forwards; }
    @keyframes sparksOpen{
      0%{ opacity:0; transform: scale(.96); }
      35%{ opacity:.55; }
      100%{ opacity:.08; transform: scale(1.06); }
    }
    @keyframes sparksReveal{
      0%{ opacity:.06; transform: scale(1.00); }
      35%{ opacity:.45; transform: scale(1.10); }
      100%{ opacity:0; transform: scale(1.16); }
    }

    /* Falling particles (no blur) */
    .falling{
      position:absolute;
      inset:-20%;
      opacity:0;
      pointer-events:none;
      background:
        radial-gradient(circle, rgba(255,255,255,.10) 1px, transparent 2px) 0 0/ 90px 90px,
        radial-gradient(circle, color-mix(in srgb, var(--accent) 16%, transparent) 1px, transparent 2px) 20px 30px/ 120px 120px,
        radial-gradient(circle, color-mix(in srgb, var(--accent) 12%, transparent) 1px, transparent 2px) 40px 10px/ 150px 150px;
      transform: translateY(-40px);
      will-change: transform, opacity;
    }
    #award[data-phase="open"] .falling,
    #award[data-phase="impact"] .falling,
    #award[data-phase="reveal"] .falling,
    #award[data-phase="done"] .falling{
      opacity:.50;
      animation: fallingMove 2.8s linear infinite;
    }
    @keyframes fallingMove{
      from{ transform: translateY(-40px); }
      to{ transform: translateY(140px); }
    }

    /* Micro zoom on impact (short) */
    #award[data-phase="impact"] .center{
      animation: microZoom 300ms ease forwards;
    }
    @keyframes microZoom{
      0%{ transform: scale(1); }
      30%{ transform: scale(1.015); }
      100%{ transform: scale(1); }
    }

    /* =========================================================
       BADGE (ONE IMAGE + slices)
       ========================================================= */
    .rankBadge{
      position:relative;
      width: min(760px, 92vw);
      height: min(760px, 92vw);
      display:grid;
      place-items:center;
      transform: translateY(0) scale(1);
      opacity: 1;
      will-change: transform, opacity;
      --badge-url: url("assets/ranks/eidolon.webp");
    }

    .rankBadge__img{
      width: min(600px, 82vw);
      height: min(600px, 82vw);
      background: var(--badge-url) center/contain no-repeat;
      filter: drop-shadow(0 0 18px rgba(0,0,0,.35));
      opacity:0; /* visible after assembly */
    }

    /* 4 slices */
    .slice{
      position:absolute;
      inset: 8%;
      background: var(--badge-url) center/contain no-repeat;
      opacity:0;
      will-change: transform, opacity;
    }
    .slice.s1{ clip-path: polygon(0 0, 50% 0, 50% 50%, 0 50%); }
    .slice.s2{ clip-path: polygon(50% 0, 100% 0, 100% 50%, 50% 50%); }
    .slice.s3{ clip-path: polygon(0 50%, 50% 50%, 50% 100%, 0 100%); }
    .slice.s4{ clip-path: polygon(50% 50%, 100% 50%, 100% 100%, 50% 100%); }

    #award[data-phase="open"] .slice{ animation: sliceIn 900ms cubic-bezier(.2,.9,.2,1) forwards; }
    #award[data-phase="open"] .slice.s1{ transform: translate(-70px,-70px) scale(.92); }
    #award[data-phase="open"] .slice.s2{ transform: translate(70px,-70px) scale(.92); }
    #award[data-phase="open"] .slice.s3{ transform: translate(-70px,70px) scale(.92); }
    #award[data-phase="open"] .slice.s4{ transform: translate(70px,70px) scale(.92); }

    @keyframes sliceIn{
      0%{ opacity:0; }
      35%{ opacity:1; }
      100%{ opacity:1; transform: translate(0,0) scale(1); }
    }

    /* Show final image from impact to end; hide slices after impact */
    #award[data-phase="impact"] .rankBadge__img,
    #award[data-phase="reveal"] .rankBadge__img,
    #award[data-phase="done"] .rankBadge__img{ opacity:1; }

    #award[data-phase="impact"] .slice,
    #award[data-phase="reveal"] .slice,
    #award[data-phase="done"] .slice{ opacity:0; transition: opacity 120ms ease; }

    /* Halo (no blur) */
    .rankBadge__halo{
      position:absolute;
      inset:-28%;
      border-radius:999px;
      pointer-events:none;
      opacity:.18;
      transform: scale(1.02);
      will-change: transform, opacity;
      background:
        radial-gradient(closest-side, rgba(255,255,255,.06), transparent 62%),
        radial-gradient(closest-side, color-mix(in srgb, var(--accent) 16%, transparent), transparent 68%),
        conic-gradient(from 0deg,
          rgba(255,255,255,0) 0deg,
          color-mix(in srgb, var(--accent) 16%, transparent) 36deg,
          rgba(255,255,255,0) 120deg,
          color-mix(in srgb, var(--accent) 10%, transparent) 200deg,
          rgba(255,255,255,0) 360deg
        );
    }

    /* Tier strength */
    .rankBadge.tier-0 .rankBadge__halo{ opacity:.14; transform: scale(.98); }
    .rankBadge.tier-1 .rankBadge__halo{ opacity:.22; transform: scale(1.01); }
    .rankBadge.tier-2 .rankBadge__halo{ opacity:.32; transform: scale(1.04); }
    .rankBadge.is-top .rankBadge__halo{ opacity:.40; transform: scale(1.06); }

    /* Impact halo burst */
    #award[data-phase="impact"] .rankBadge__halo{
      animation: haloBurst 560ms ease forwards;
    }
    @keyframes haloBurst{
      0%{ opacity: .22; transform: scale(1.02); }
      35%{ opacity: .85; transform: scale(1.10) rotate(8deg); }
      100%{ opacity: .28; transform: scale(1.05) rotate(0deg); }
    }

    /* Idle glow in done */
    #award[data-phase="done"] .rankBadge__halo{
      animation: haloIdle 1.9s ease-in-out infinite;
    }
    @keyframes haloIdle{
      0%,100%{ opacity:.24; transform: scale(1.03); }
      50%{ opacity:.42; transform: scale(1.08); }
    }

    /* Badge pop */
    .rankBadge.anim-up{ animation: badgePop 820ms cubic-bezier(.12,.95,.18,1) forwards; }
    @keyframes badgePop{
      0%{ transform: translateY(6px) scale(.98); }
      35%{ transform: translateY(-8px) scale(1.07); }
      100%{ transform: translateY(0) scale(1); }
    }

   /* =========================================================
   LABEL (FINAL): always visible under badge
   ========================================================= */

/* place label under badge, above ALL fx */
#award .label{
  position: relative;
  margin-top: 44px;
  width: 100%;
  text-align: center;

  opacity: 0;
  pointer-events: none;

  /* ✅ force on top of fx layers */
  z-index: 999;
  isolation: isolate;
}

/* show ONLY at reveal/done */
#award[data-phase="reveal"] .label,
#award[data-phase="done"] .label{
  opacity: 1 !important;
  animation: labelIn 320ms cubic-bezier(.2,.9,.2,1) forwards;
}

#award .labelTop{
  font-size: 12px;
  letter-spacing: .28em;
  text-transform: uppercase;
  color: rgba(255,255,255,.60);
}

#award .labelName{
  font-size: 56px;
  font-weight: 900;
  letter-spacing: .22em;
  text-transform: uppercase;
  color: #fff;
  text-shadow: none !important;
  line-height: 1.05;

  /* ✅ ADD (start hidden) */
  opacity: 0;
  transform: translate3d(0, 10px, 0) scale(.98);
  will-change: transform, opacity;
}

    #award.is-tierup .label{ display:block; }

    #award.is-rankup[data-phase="reveal"] .label,
    #award.is-rankup[data-phase="done"] .label{
      opacity:1;
      animation: labelIn 620ms cubic-bezier(.2,.9,.2,1) forwards;
    }
  #award.is-tierup[data-phase="reveal"] .label,
#award.is-tierup[data-phase="done"] .label{
  opacity:1;
  animation: labelIn 520ms cubic-bezier(.2,.9,.2,1) forwards;
}
  
    @keyframes labelIn{
  from{ opacity:0; }
  to{ opacity:1; }
}
  
  /* ✅ LabelName appears on REVEAL / DONE */
#award[data-phase="reveal"] #labelName,
#award[data-phase="done"] #labelName{
  opacity: .96;
  transform: translate3d(0, 0, 0) scale(1);
  transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease;
}
  
/* ✅ Show label for ANY mode (rank up / tier up / down) */
#award[data-phase="reveal"] .label,
#award[data-phase="done"] .label{
  opacity: 1;
  animation: labelIn 420ms cubic-bezier(.2,.9,.2,1) forwards;
}
  
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      #award[data-phase="impact"] .impactFlash,
      #award[data-phase="impact"] .coreFlash,
      #award[data-phase="impact"] .center,
      #award[data-phase="reveal"] .creationGlow,
      #award[data-phase="reveal"] .wingWave,
      #award[data-phase="open"] .slice,
      #award[data-phase="open"] .sparks,
      #award[data-phase="reveal"] .sparks,
      #award[data-phase="open"] .falling,
      #award[data-phase="impact"] .falling,
      #award[data-phase="reveal"] .falling,
      #award[data-phase="done"] .falling,
      #award[data-phase="done"] .rankBadge__halo,
      .rankBadge.anim-up{
        animation:none !important;
      }
      .label{ opacity:1; }
    }

  .tierHUD{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:12px;
  opacity:.9;
}
.tierHUD__dot{
  width:10px; height:10px; border-radius:999px;
  background: rgba(255,255,255,.14);
}
.tierHUD__dot.is-on{
  background: color-mix(in srgb, var(--rank-accent, #22d3ee) 65%, white);
  box-shadow: 0 0 10px color-mix(in srgb, var(--rank-accent, #22d3ee) 35%, transparent);
}

  #award.is-rankup[data-phase="done"] .rankBadge{
  animation: heroHold 900ms ease-out forwards;
}
@keyframes heroHold{
  0%{ transform: scale(1); }
  40%{ transform: scale(1.015); }
  100%{ transform: scale(1); }
}

  /* =========================================================
   FINAL FORCE: DOWN + TIER (unique keyframes)
   Put at VERY END of <style>
   ========================================================= */

/* DOWN */
#award.is-down .rankBadge{
  animation: awardDownShake 340ms ease forwards !important;
}
@keyframes awardDownShake{
  0%{ transform: translateY(0) scale(1); }
  25%{ transform: translateY(7px) scale(.982); }
  55%{ transform: translateY(-3px) scale(.978); }
  100%{ transform: translateY(0) scale(1); }
}

/* dimming clearly visible */
#award.is-down .veil{
  opacity: 1 !important;
  filter: saturate(.80) brightness(.88);
}
#award.is-down .center::before{
  opacity: .35 !important;
}
#award.is-down .rankBadge__halo{
  opacity: .06 !important;
  transform: scale(.95) !important;
}
#award.is-down .wingWave,
#award.is-down .creationGlow{
  display:none !important;
}

/* TIER INTENSITY — make it obvious */
#award[data-tier="0"] .rankBadge__halo{ opacity: .14 !important; transform: scale(.98) !important; }
#award[data-tier="1"] .rankBadge__halo{ opacity: .34 !important; transform: scale(1.10) !important; }
#award[data-tier="2"] .rankBadge__halo{ opacity: .56 !important; transform: scale(1.18) !important; }

#award[data-tier="0"] .falling{ opacity: .18 !important; }
#award[data-tier="1"] .falling{ opacity: .45 !important; }
#award[data-tier="2"] .falling{ opacity: .80 !important; }

#award[data-tier="0"][data-phase="reveal"] .creationGlow{ animation-duration: 850ms !important; }
#award[data-tier="1"][data-phase="reveal"] .creationGlow{ animation-duration: 1150ms !important; }
#award[data-tier="2"][data-phase="reveal"] .creationGlow{ animation-duration: 1550ms !important; }

#award[data-tier="0"][data-phase="reveal"] .wingWave{ animation-duration: 850ms !important; opacity:0 !important; }
#award[data-tier="1"][data-phase="reveal"] .wingWave{ animation-duration: 1150ms !important; }
#award[data-tier="2"][data-phase="reveal"] .wingWave{ animation-duration: 1550ms !important; }
  
  /* =========================
   ICON GLITCH (local, no frame)
   ========================= */
#rankIcon{
  position: relative;
  will-change: transform, filter;
}

#award.is-finisher #rankIcon{
  animation: iconGlitch 420ms steps(1,end) forwards;
}

@keyframes iconGlitch{
  0%   { transform: translate3d(0,0,0) scale(1); filter: none; opacity:1; }
  10%  { transform: translate3d(-6px,-1px,0) scale(1.02); filter: hue-rotate(18deg) saturate(1.35) contrast(1.12); }
  25%  { transform: translate3d(7px,1px,0)  scale(1.03); filter: hue-rotate(-22deg) saturate(1.45) contrast(1.18); }
  40%  { transform: translate3d(-4px,0px,0) scale(1.02); filter: contrast(1.25); }
  55%  { transform: translate3d(5px,0px,0)  scale(1.02); filter: hue-rotate(10deg) contrast(1.18); }
  70%  { transform: translate3d(-3px,1px,0) scale(1.01); filter: contrast(1.10); }
  100% { transform: translate3d(0,0,0) scale(1); filter: none; opacity:1; }
}

/* Vibration on badge container (subtle) */
#award.is-finisher .rankBadge{
  animation: finisherVibe 520ms ease forwards;
}

@keyframes finisherVibe{
  0%{ transform: translateY(0) scale(1); }
  20%{ transform: translateY(-2px) scale(1.03); }
  40%{ transform: translateX(-4px) scale(1.03); }
  60%{ transform: translateX(4px) scale(1.03); }
  80%{ transform: translateX(-2px) scale(1.02); }
  100%{ transform: translateY(0) scale(1); }
}
  
  /* =========================
   HUD MESSAGE (Apex Mobile style)
   ========================= */

/* base */
#award .hud .sub{
  opacity: 0;
  transform: translateY(-6px);
  will-change: transform, opacity;
}

/* show on reveal+done */
#award[data-phase="reveal"] .hud .sub,
#award[data-phase="done"] .hud .sub{
  animation: hudMsgIn 520ms cubic-bezier(.2,.9,.2,1) forwards;
}

@keyframes hudMsgIn{
  0%{ opacity:0; transform: translateY(-8px); }
  60%{ opacity:1; transform: translateY(0); }
  100%{ opacity:.92; transform: translateY(0); }
}

/* different tone for DOWN */
#award.is-down .hud .sub{
  color: rgba(152,162,179,.92);
}

/* optional: punchy for UP */
#award.is-up .hud .sub{
  color: rgba(234,242,255,.88);
  text-shadow: 0 0 14px color-mix(in srgb, var(--accent) 18%, transparent);
}
  /* =========================
   HUD TEXT (Apex Mobile style) — show earlier
   Put at VERY END of <style>
   ========================= */

#award .hud{ z-index: 60; }


/* base hidden */
#award #subText{
  opacity: 0;
  transform: translate3d(0,-8px,0);
  will-change: opacity, transform;
}

/* animate ONCE on OPEN */
#award[data-phase="open"] #subText{
  animation: awardHudIn 420ms cubic-bezier(.2,.9,.2,1) forwards;
}

/* keep visible after (no restart => no flicker) */
#award[data-phase="impact"] #subText,
#award[data-phase="reveal"] #subText,
#award[data-phase="done"] #subText{
  opacity: .92;
  transform: translate3d(0,0,0);
}

@keyframes awardHudIn{
  0%{ opacity:0; transform: translateY(-10px); }
  100%{ opacity:.92; transform: translateY(0); }
}
  
  /* =========================================================
   TOP BANNER (Apex-style, symmetric, rank-tinted, FPS-safe)
   Requires: .shimmerLine inside .apexBanner__plate
   Uses: --accent from #award (set in JS)
   ========================================================= */

.apexBanner{
  position:absolute;
  top: 16px;
  left: 50%;
  width: min(860px, 94vw);
  transform: translate3d(-50%,-14px,0);
  opacity: 0;
  pointer-events:none;
  z-index: 80;
  contain: layout paint style;
  will-change: transform, opacity;
}

/* Keep banner visible after open (no re-trigger flicker) */
#award[data-phase="open"] .apexBanner,
#award[data-phase="impact"] .apexBanner,
#award[data-phase="reveal"] .apexBanner,
#award[data-phase="done"] .apexBanner,
#award[data-phase="impact"] .apexBanner,
#award[data-phase="reveal"] .apexBanner,
#award[data-phase="done"] .apexBanner{
  opacity: 1;
  transform: translate3d(-50%,0,0);
}

/* Entrance animation happens on OPEN only */
#award[data-phase="open"] .apexBanner{
  transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 160ms ease;
}

.apexBanner__plate{
  position: relative;
  height: 46px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;

  /* Flat metal plate (like your screenshot) */
  background:
    linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.08)),
    linear-gradient(90deg, rgba(255,255,255,.10), rgba(0,0,0,0) 40%, rgba(255,255,255,.10));

  /* Rank-tinted border */
  border: 1px solid color-mix(in srgb, var(--accent) 35%, rgba(255,255,255,.18));

  /* Symmetric cut ends */
  clip-path: polygon(
    56px 0%,
    calc(100% - 56px) 0%,
    100% 50%,
    calc(100% - 56px) 100%,
    56px 100%,
    0% 50%
  );

  /* Shadows + inner trims */
  box-shadow:
    0 18px 46px rgba(0,0,0,.35),
    0 0 26px color-mix(in srgb, var(--accent) 18%, transparent),
    inset 0 1px rgba(255,255,255,.14),
    inset 0 -1px rgba(0,0,0,.18);

  will-change: transform;
  transform: translate3d(0,0,0);
}

/* LEFT slashes (symmetric) */
.apexBanner__plate::before{
  content:"";
  position:absolute;
  left: 18px;
  top: 50%;
  width: 74px;
  height: 18px;
  transform: translateY(-50%);
  background:
    linear-gradient(135deg, rgba(255,255,255,.38) 0 0) left/18px 100% no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.22) 0 0) center/18px 100% no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.14) 0 0) right/18px 100% no-repeat;
  opacity:.65;
}

/* RIGHT slashes (symmetric) */
.apexBanner__plate::after{
  content:"";
  position:absolute;
  right: 18px;
  top: 50%;
  width: 74px;
  height: 18px;
  transform: translateY(-50%);
  background:
    linear-gradient(135deg, rgba(255,255,255,.38) 0 0) left/18px 100% no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.22) 0 0) center/18px 100% no-repeat,
    linear-gradient(135deg, rgba(255,255,255,.14) 0 0) right/18px 100% no-repeat;
  opacity:.65;
}

/* Shimmer line (impact wipe) */
.apexBanner__plate .shimmerLine{
  position:absolute;
  inset:-60% -80%;
  background: linear-gradient(
    90deg,
    transparent,
    color-mix(in srgb, var(--accent) 28%, rgba(255,255,255,.38)),
    transparent
  );
  transform: translate3d(-55%,0,0) skewX(-18deg);
  opacity: 0;
  pointer-events:none;
  will-change: transform, opacity;
}

/* Banner title */
.apexBanner__title{
  text-align:center;
  font-weight: 900;
  letter-spacing: .06em;
  text-transform: uppercase;
  font-size: 15px;
  color: rgba(245,248,255,.92);
  text-shadow:
    0 0 12px color-mix(in srgb, var(--accent) 22%, transparent),
    0 0 10px rgba(255,255,255,.08);

  /* Start hidden; appear fast */
  opacity: 0;
  transform: translate3d(0,6px,0);
  will-change: transform, opacity;
}

/* ✅ Title appears EARLY (open), not halfway */
#award[data-phase="open"] .apexBanner__title{
  opacity: 1;
  transform: translate3d(0,0,0);
  transition: transform 180ms cubic-bezier(.2,.9,.2,1), opacity 140ms ease;
  transition-delay: 120ms;
}

/* Keep title visible afterwards (no restart) */
#award[data-phase="impact"] .apexBanner__title,
#award[data-phase="reveal"] .apexBanner__title,
#award[data-phase="done"] .apexBanner__title{
  opacity: 1;
  transform: translate3d(0,0,0);
}

/* Impact pulse + shimmer wipe */
#award[data-phase="impact"] .apexBanner__plate{
  animation: apexBannerPulse 240ms ease forwards;
}
#award[data-phase="impact"] .apexBanner__plate .shimmerLine{
  opacity: .9;
  transform: translate3d(65%,0,0) skewX(-18deg);
  transition: transform 420ms ease, opacity 160ms ease;
}

@keyframes apexBannerPulse{
  0%{ transform: scale(1); }
  45%{ transform: scale(1.01); }
  100%{ transform: scale(1); }
}
  
  /* ✅ Banner tint: guaranteed visible (even for dark ranks like outcast) */
.apexBanner__plate{
  box-shadow:
    0 18px 46px rgba(0,0,0,.35),
    0 0 0 2px var(--accent),
    0 0 26px var(--accent),
    inset 0 1px rgba(255,255,255,.14),
    inset 0 -1px rgba(0,0,0,.18) !important;
  border-color: rgba(255,255,255,.16) !important;
}
  /* ✅ Plate tinted by rank color */
.apexBanner__plate{
  background:
    linear-gradient(180deg,
      color-mix(in srgb, var(--accent) 22%, rgba(255,255,255,.18)),
      color-mix(in srgb, var(--accent) 10%, rgba(0,0,0,.10))
    );
  border: 1px solid var(--accent);
  box-shadow:
    0 18px 46px rgba(0,0,0,.35),
    0 0 0 2px var(--accent),
    0 0 22px var(--accent),
    inset 0 1px rgba(255,255,255,.14),
    inset 0 -1px rgba(0,0,0,.18);
}

.apexBanner__title{
  color: #ffffff;
  text-shadow: none !important;   /* ✅ без світіння */
}
  
  #award[data-phase="reveal"] .label,
#award[data-phase="done"] .label{
  opacity: 1;
  animation: labelIn 420ms cubic-bezier(.2,.9,.2,1) forwards;
}
  
  /* =========================================================
   FINAL: RANK NAME (clean, no duplicates)
   Works for RankUp + RankDown + TierUp + TierDown
   ========================================================= */

/* position label */
#rankLabel{
  position: fixed;
  left: 50%;
  bottom: 45px;                  /* base */
  transform: translateX(-50%);
  width: min(920px, 96vw);
  text-align: center;
  pointer-events: none;
  z-index: 999999;
  opacity: 0;
  visibility: hidden;
}

/* ONLY show during reveal/done */
#award.is-open[data-phase="reveal"] #rankLabel,
#award.is-open[data-phase="done"] #rankLabel{
  opacity: 1;
  visibility: visible;
}

/* hide top label line always */
#labelTop{ display: none !important; }

/* AAA rank name */
#labelName{
  display: inline-block;
  position: relative;
  overflow: hidden;

  font-family: "Bahnschrift", "Segoe UI", system-ui, sans-serif;
  font-size: 60px;
  font-weight: 950;
  letter-spacing: .34em;
  text-transform: uppercase;
  color: rgba(255,255,255,.96);
  line-height: 1.02;

  text-shadow:
    0 10px 30px rgba(0,0,0,.45),
    0 0 16px color-mix(in srgb, var(--accent) 12%, transparent);

  opacity: 0;
  transform: translateY(18px) scale(.96);
  will-change: transform, opacity;
}

/* underline */
#labelName::after{
  content:"";
  display:block;
  margin: 14px auto 0;
  width: 52%;
  height: 2px;
  border-radius: 999px;
  background: linear-gradient(90deg,
    transparent,
    color-mix(in srgb, var(--accent) 28%, rgba(255,255,255,.35)),
    transparent
  );
  opacity: .65;
}

/* shimmer wipe */
#labelName::before{
  content:"";
  position:absolute;
  inset:-40% -60%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.32), transparent);
  transform: translateX(-60%) skewX(-18deg);
  opacity: 0;
  pointer-events:none;
}

/* animate ONCE on reveal */
#award.is-open[data-phase="reveal"] #labelName{
  opacity: 1;
  transform: translateY(0) scale(1);
  animation: namePop 520ms cubic-bezier(.16,.9,.2,1) forwards;
}

#award.is-open[data-phase="reveal"] #labelName::before{
  opacity: .6;
  transform: translateX(70%) skewX(-18deg);
  transition: transform 520ms ease, opacity 220ms ease;
}

/* HOLD on done (no restart => no flicker) */
#award.is-open[data-phase="done"] #labelName{
  opacity: 1;
  transform: translateY(0) scale(1);
  animation: nameBreath 2.2s ease-in-out infinite;
}

/* down mode: slightly dim, no flicker */
#award.is-down[data-phase="done"] #labelName{
  opacity: .92;
  filter: none;
}

@keyframes namePop{
  0%{ opacity:0; transform: translateY(18px) scale(.96); }
  55%{ opacity:1; transform: translateY(-2px) scale(1.02); }
  100%{ opacity:1; transform: translateY(0) scale(1); }
}

@keyframes nameBreath{
  0%,100%{ opacity: .94; }
  50%{ opacity: 1; }
}

/* =========================================================
   OVERLORD ONLY: push label a bit lower
   (we set this attribute from JS)
   ========================================================= */
#award[data-rankkey="overlord"] #rankLabel{
  bottom: 18px;
}
  /* underline glint on reveal */
#award.is-open[data-phase="reveal"] #labelName::after{
  animation: underlineGlint 520ms ease forwards;
}

@keyframes underlineGlint{
  0%{ opacity: .15; transform: scaleX(.55); }
  45%{ opacity: .9; transform: scaleX(1.02); }
  100%{ opacity: .65; transform: scaleX(1); }
}
  /* Up: slightly more heroic */
#award.is-up[data-phase="reveal"] #labelName{
  animation: namePopUp 520ms cubic-bezier(.16,.9,.2,1) forwards;
}

@keyframes namePopUp{
  0%{ opacity:0; transform: translateY(18px) scale(.96); }
  55%{ opacity:1; transform: translateY(-4px) scale(1.03); }
  100%{ opacity:1; transform: translateY(0) scale(1); }
}

/* Down: calmer */
#award.is-down[data-phase="reveal"] #labelName{
  animation: namePopDown 420ms cubic-bezier(.16,.9,.2,1) forwards;
}

@keyframes namePopDown{
  0%{ opacity:0; transform: translateY(12px) scale(.98); }
  100%{ opacity:1; transform: translateY(0) scale(1); }
}
  
</style>
  <!-- ===== END OF CSS ===== -->
</head>
  
<!-- ============================= -->
<!-- ===== APPLICATION UI ======= -->
<!-- ============================= -->
<body>

<!-- NAVIGATION -->
<div class="navbar">
  <button class="nav-btn active" onclick="showTab('dashboard', this)">PLAYER HUB</button>
  <button class="nav-btn" onclick="showTab('rank', this)">RANK</button>
  <button class="nav-btn" onclick="showTab('history', this)">MATCH HISTORY</button>
  <button class="nav-btn" onclick="showTab('add', this)">ADD MATCH</button>
</div>
  
<div class="app">
  
<!-- PLAYER HUB -->
<div id="dashboard" class="section active">
  <div class="page-title">Player Hub</div>
  <div class="page-subtitle">Your ranked progression at a glance.</div>

  <div class="grid-hero">
    <!-- HERO: Rank summary -->
    <div class="card pad interactive">
      <div class="kicker">Current Status</div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; margin-top:14px; flex-wrap:wrap;">
        <div>
          <div style="font-family:var(--font-ui); font-size:32px; font-weight:900; letter-spacing:.06em; color:var(--text-strong);" id="phRankLabel">PHANTOM II</div>
          <div class="muted" style="margin-top:6px;" id="phRRText">RR: 1250 / 1500</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" type="button" onclick="showTab('rank', document.querySelectorAll('.nav-btn')[1])">View Rank</button>
          <button class="btn" type="button" onclick="showTab('add', document.querySelectorAll('.nav-btn')[3])">Add Match</button>
          <button class="btn danger" type="button" onclick="startNewSeason()">New Season</button>
        </div>
      </div>

      <div class="progress"><div id="phProgressFill" style="width:83%"></div></div>
      <div class="muted" style="margin-top:10px;">
        Goal: reach next division / tier — keep the streak alive.
      <div class="hubHeroBottom">
  <div class="hubStatusPills">
    <span class="pill">Tier <strong id="phTier">I</strong></span>
    <span class="pill">Next <strong id="phNext">2100</strong></span>
    <span class="pill" id="phStatePill">Status <strong id="phState">Stable</strong></span>
  </div>

  <div class="hubEmblem">
    <img id="phBadgeImg" src="assets/ranks/overlord.webp" alt="Rank emblem">
  </div>
</div>

   <!-- SIDE: Quick stats -->
    <div class="card pad">
      <div class="kicker">Session</div>

      <div style="margin-top:14px; display:grid; gap:12px;">
        <div class="tile">
          <div class="k">Matches</div>
          <div class="v" id="phMatches">0</div>
          <div class="sub">This season total</div>
        </div>

        <div class="tile">
          <div class="k">Win Streak</div>
          <div class="v" id="phStreak">0</div>
          <div class="sub">Top-3 streak</div>
        </div>

        <div class="tile">
          <div class="k">Average RR</div>
          <div class="v" id="phAvg">0</div>
          <div class="sub">Avg RR / match</div>
        </div>
      </div>
    </div>
  </div><!-- /grid-hero -->

  <!-- TILES -->
  <div class="tiles">
    <div class="tile">
      <div class="k">Best Match</div>
      <div class="v" id="phBest">+0</div>
      <div class="sub">Peak RR gain</div>
    </div>
    <div class="tile">
      <div class="k">Worst Match</div>
      <div class="v" id="phWorst">0</div>
      <div class="sub">Lowest RR loss</div>
    </div>
    <div class="tile">
      <div class="k">Matches</div>
      <div class="v" id="phMatches2">0</div>
      <div class="sub">This season total</div>
    </div>
  </div>

  <!-- RECENT -->
  <div style="margin-top: var(--s8);" class="card pad">
    <div class="kicker">Recent Matches</div>
    <div class="muted" style="margin-top:6px;">Preview (full list in Match History)</div>

    <div id="phRecent" style="margin-top:14px; display:grid; gap:10px;"></div>

    <div class="linkRow">
      <button class="linkBtn" type="button"
        onclick="showTab('history', document.querySelectorAll('.nav-btn')[2])">
        View full history →
      </button>
    </div>
  </div>
</div><!-- /dashboard -->
  
<!-- RANK -->
<div id="rank" class="section">
  <h1>Competitive Rank</h1>
  <p>Your current competitive standing.</p>

  <!-- RANK CARD -->
  <div class="rank-card">
    <div class="rank-bg"></div>
    <div class="rank-noise"></div>

    <div class="rank-icon" id="rankCardIcon">
  <img id="rankBadgeImg" src="" alt="Rank badge">
  <div class="rank-glow"></div>
    </div>

    <div class="rank-info">
      <h2 id="rankCardTitle">PHANTOM II</h2>
      <span class="rank-rp" id="rankCardRP">RP: 1250 / 1500</span>
      <div class="chip" id="rankCardChip">NEON ASCENSION</div>
      
      <div class="tierHUD" id="rankTierHUD" aria-hidden="true">
  <span class="tierHUD__dot"></span>
  <span class="tierHUD__dot"></span>
  <span class="tierHUD__dot"></span>
</div>

      <div class="rp-bar">
        <div class="rp-fill" id="rankCardFill" style="width: 83%;"></div>
      </div>
    </div>
  </div>

  <!-- RANK LADDER (OUTSIDE rank-card) -->
  <div class="ladder">
    <div class="ladder-head">
      <h3>Rank Ladder</h3>
      <span class="ladder-note">Locked ranks are dimmed. Current rank is highlighted.</span>
    </div>

    <div class="ladder-list">
      <div class="ladder-item unlocked">
        <div class="badge b-outcast"></div>
        <div class="meta">
          <div class="name">OUTCAST</div>
          <div class="desc">Chaos-born survivors.</div>
        </div>
      </div>

      <div class="ladder-item unlocked">
        <div class="badge b-thrall"></div>
        <div class="meta">
          <div class="name">THRALL</div>
          <div class="desc">Rising force.</div>
        </div>
      </div>

      <div class="ladder-item unlocked">
        <div class="badge b-marauder"></div>
        <div class="meta">
          <div class="name">MARAUDER</div>
          <div class="desc">Control & discipline.</div>
        </div>
      </div>

      <div class="ladder-item unlocked current">
        <div class="badge b-harbinger"></div>
        <div class="meta">
          <div class="name">HARBINGER</div>
          <div class="desc">Precision mastery.</div>
        </div>
      </div>

      <div class="ladder-item locked">
        <div class="badge b-reaper"></div>
        <div class="meta">
          <div class="name">REAPER</div>
          <div class="desc">Aggressive dominance.</div>
        </div>
      </div>

      <div class="ladder-item locked">
        <div class="badge b-archon"></div>
        <div class="meta">
          <div class="name">ARCHON</div>
          <div class="desc">Authority.</div>
        </div>
      </div>

      <div class="ladder-item locked">
        <div class="badge b-overlord"></div>
        <div class="meta">
          <div class="name">OVERLORD</div>
          <div class="desc">Vision & tactics.</div>
        </div>
      </div>

      <div class="ladder-item locked">
        <div class="badge b-monarch"></div>
        <div class="meta">
          <div class="name">MONARCH</div>
          <div class="desc">Transcendence.</div>
        </div>
      </div>

      <div class="ladder-item locked">
        <div class="badge b-seraph"></div>
        <div class="meta">
          <div class="name">SERAPH</div>
          <div class="desc">Elite standard.</div>
        </div>
      </div>

      <div class="ladder-item locked nexus">
        <div class="badge b-eidolon"></div>
        <div class="meta">
          <div class="name">EIDOLON</div>
          <div class="desc">Absolute peak.</div>
        </div>
      </div>
    </div>
  </div>
</div>

  
<!-- ADD MATCH -->
<div id="add" class="section">
  <h1>Add Match</h1>
  <p>Enter your match results. Everything updates automatically.</p>

  <div class="panel form">
    <div class="grid">
      <label>🏆 Place (1–25)
        <input id="inPlace" type="number" min="1" max="25" value="10">
      </label>

      <label>🔫 Kills
        <input id="inKills" type="number" min="0" value="0">
      </label>

      <label>🤝 Assists
        <input id="inAssists" type="number" min="0" value="0">
      </label>

      <label>💀 Deaths
        <input id="inDeaths" type="number" min="0" value="1">
      </label>
    </div>

    <div class="toggles">
      <label class="toggle">
        <input id="inMVP" type="checkbox">
        <span>⭐ MVP</span>
      </label>

      <label class="toggle">
        <input id="inLeft" type="checkbox">
        <span>⚠ Teammate Left</span>
      </label>
    </div>

    <div class="actions">
      <button type="button" class="btn" onclick="submitMatch()">Submit Match</button>
      <button class="btn" onclick="undoLastMatch()">Undo Last Match</button>
      <button class="btn ghost" onclick="resetMatches()">Reset All Data</button>
      <div class="hint">Data is stored locally in your browser.</div>
    </div>
    <div class="panel" style="margin-top:16px;">
  <h3 style="margin-bottom:10px; letter-spacing:.6px;">Export / Import</h3>
  <p style="color:#9ca3af; font-size:12px; margin-bottom:10px;">
    Backup your matches as JSON, or import them on another device.
  </p>

  <textarea id="ioBox" rows="8" style="
    width:100%;
    resize:vertical;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(2,6,23,0.55);
    color:#e5e7eb;
    outline:none;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size:12px;
    line-height:1.4;
  " placeholder="Paste JSON here (Import) or click Export to generate..."></textarea>

  <div class="actions" style="margin-top:10px;">
    <button class="btn" onclick="exportData()">Export JSON</button>
    <button class="btn" onclick="importData()">Import JSON</button>
    <button class="btn ghost" onclick="clearIO()">Clear Box</button>
    <button class="btn ghost" onclick="restoreBackup()">Restore Backup</button>
  </div>

  <div class="hint">Tip: Export copies JSON to clipboard automatically.</div>
</div>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="section">
  <h1>Match History</h1>
  <p>Your recent ranked matches and RP changes.</p>

  <div class="history-top">
    <div class="mini-card">
      <div class="mini-label">Win Streak</div>
      <div class="mini-value" id="streakValue">0</div>
    </div>
    <div class="mini-card">
      <div class="mini-label">Best Match</div>
      <div class="mini-value" id="bestValue">+0</div>
    </div>
    <div class="mini-card">
      <div class="mini-label">Worst Match</div>
      <div class="mini-value" id="worstValue">0</div>
    </div>
    <div class="season-summary" id="seasonSummary"></div>
  </div>

  <div class="history-controls">
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <label style="font-size:12px; color:#9ca3af;">Season:</label>
    <select id="seasonSelect" class="season-select"></select>
    <span id="readOnlyBadge" class="ro-badge" style="display:none;">READ ONLY</span>
    <button class="btn" id="toggleHistoryBtn" type="button">Show all</button>
    <button class="btn" type="button" onclick="renameSeason()">Rename</button>
    <button class="btn" type="button" onclick="renumberSeasonIds()">Fix IDs</button>
    <button class="btn ghost" type="button" onclick="deleteSeason()">Delete</button>
  </div>
  <div class="hint" id="historyHint">Showing last 20 matches</div>
</div>

<div class="match-list" id="matchList"></div>
</div>


<!-- ============================= -->
<!-- ===== APPLICATION LOGIC ===== -->
<!-- ===== JAVASCRIPT (JS) ======= -->
<!-- ============================= -->
<script>
  var sfxUp = null;
var sfxDown = null;

function preloadSfx() {
  // If files missing, it won't crash; just won't play.
  try {
    sfxUp = new Audio("assets/sfx/rank_up.mp3");
    sfxUp.preload = "auto";
    sfxUp.volume = 0.7;
  } catch(e) {}

  try {
    sfxDown = new Audio("assets/sfx/rank_down.mp3");
    sfxDown.preload = "auto";
    sfxDown.volume = 0.7;
  } catch(e) {}
}

function playSfx(mode) {
  // mode: "up" | "down"
  try {
    var a = (mode === "down") ? sfxDown : sfxUp;
    if (!a) return;
    a.currentTime = 0;
    a.play();
  } catch(e) {}
}
  
  function preloadRankBadges() {
  for (var i = 0; i < rankTiers.length; i++) {
    var img = new Image();
    img.src = "assets/ranks/" + String(rankTiers[i].name).toLowerCase() + ".webp";
  }
}
  
function showTab(tabId, btn) {
  // 1) hide all sections
  var sections = document.querySelectorAll(".section");
  for (var i = 0; i < sections.length; i++) {
    sections[i].classList.remove("active");
  }

  // 2) deactivate all nav buttons
  var buttons = document.querySelectorAll(".nav-btn");
  for (var j = 0; j < buttons.length; j++) {
    buttons[j].classList.remove("active");
  }

  // 3) show target section
  var target = document.getElementById(tabId);
  if (target) {
    target.classList.add("active");
  } else {
    console.warn("showTab: missing section id =", tabId);
  }

  // 4) season lock for ADD tab
  if (tabId === "add") {
    ensureSeasonSystem();
    var activeId = getActiveSeasonId();
    if (activeId) setSelectedSeasonId(activeId);
  }

  // 5) activate clicked button
  if (btn && btn.classList) btn.classList.add("active");
}
  // Safety: ensure navbar always switches tabs even if inline onclick glitches
(function bindNavClicks(){
  var map = {
    "PLAYER HUB": "dashboard",
    "RANK": "rank",
    "MATCH HISTORY": "history",
    "ADD MATCH": "add"
  };

  var btns = document.querySelectorAll(".nav-btn");
  for (var i = 0; i < btns.length; i++) {
    (function(b){
      b.addEventListener("click", function(){
        var key = (b.textContent || "").trim().toUpperCase();
        var id = map[key];
        if (id) showTab(id, b);
      });
    })(btns[i]);
  }
})();
  

/* ===== STORAGE ===== */
var STORAGE_KEY = "bf6_ranked_matches_v1";
  var BACKUP_KEY = "bf6_backup_v1";

function makeBackup(reason) {
  var payload = {
    version: 1,
    reason: reason || "manual",
    createdAt: Date.now(),
    seasons: loadSeasons(),
    activeSeasonId: getActiveSeasonId(),
    selectedSeasonId: getSelectedSeasonId(),
    matches: loadMatches()
  };
  localStorage.setItem(BACKUP_KEY, JSON.stringify(payload));
}

function restoreBackup() {
  var raw = localStorage.getItem(BACKUP_KEY);
  if (!raw) {
    alert("No backup found.");
    return;
  }

  var payload;
  try {
    payload = JSON.parse(raw);
  } catch (e) {
    alert("Backup is corrupted.");
    return;
  }

  if (!payload || !Array.isArray(payload.matches) || !Array.isArray(payload.seasons)) {
    alert("Backup format invalid.");
    return;
  }

  if (!confirm("Restore backup? This will replace current data.")) return;

  saveMatches(payload.matches);
  saveSeasons(payload.seasons);

  setActiveSeasonId(payload.activeSeasonId || (payload.seasons[0] && payload.seasons[0].id) || "S1");
  setSelectedSeasonId(payload.selectedSeasonId || getActiveSeasonId());

  lastRankState = null;
  renderHistoryFromStorage();

  alert("Backup restored.");
}
var SEASONS_KEY = "bf6_seasons_v1";
var ACTIVE_SEASON_KEY = "bf6_active_season_v1";
var SELECTED_SEASON_KEY = "bf6_selected_season_v1"; // for UI viewing

function loadSeasons() {
  try {
    var raw = localStorage.getItem(SEASONS_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    return [];
  }
}

function saveSeasons(seasons) {
  localStorage.setItem(SEASONS_KEY, JSON.stringify(seasons));
}

function getActiveSeasonId() {
  return localStorage.getItem(ACTIVE_SEASON_KEY);
}

function setActiveSeasonId(id) {
  localStorage.setItem(ACTIVE_SEASON_KEY, id);
}

function getSelectedSeasonId() {
  // Selected season for viewing; default to active
  var v = localStorage.getItem(SELECTED_SEASON_KEY);
  return v ? v : getActiveSeasonId();
}

function setSelectedSeasonId(id) {
  localStorage.setItem(SELECTED_SEASON_KEY, id);
}

function ensureSeasonSystem() {
  var seasons = loadSeasons();
  // Backfill season name for legacy seasons
  var changed = false;
  for (var i = 0; i < seasons.length; i++) {
    if (!seasons[i].name) {
      seasons[i].name = seasons[i].id; // default name
      changed = true;
    }
  }
  if (changed) saveSeasons(seasons);
  var active = getActiveSeasonId();

  if (!seasons || seasons.length === 0 || !active) {
    // Create first season
    var id = "S1";
    var season = {
      id: id,
      startAt: Date.now(),
      endAt: null,
      finalRR: null,
      finalRankLabel: null,
      stats: null
    };
    saveSeasons([season]);
    setActiveSeasonId(id);
    setSelectedSeasonId(id);
    return;
  }

  // If selected missing, set to active
  var selected = getSelectedSeasonId();
  if (!selected) setSelectedSeasonId(active);
}
  function computeSeasonStats(matches) {
  var count = matches.length;
  if (count === 0) {
    return {
      matchesCount: 0,
      bestRR: 0,
      worstRR: 0,
      avgRR: 0,
      top1Count: 0,
      top3Count: 0,
      top7Count: 0,
      mvpCount: 0,
      leftCount: 0
    };
  }

  var best = -Infinity;
  var worst = Infinity;
  var sum = 0;

  var top1 = 0, top3 = 0, top7 = 0, mvpCount = 0, leftCount = 0;

  for (var i = 0; i < matches.length; i++) {
    var m = matches[i];
    var rr = Number(m.rp || 0);
    sum += rr;
    if (rr > best) best = rr;
    if (rr < worst) worst = rr;

    var p = Number(m.place || 99);
    if (p === 1) top1++;
    if (p <= 3) top3++;
    if (p <= 7) top7++;

    if (m.mvp) mvpCount++;
    if (m.left) leftCount++;
  }

  return {
    matchesCount: count,
    bestRR: best,
    worstRR: worst,
    avgRR: Math.round(sum / count),
    top1Count: top1,
    top3Count: top3,
    top7Count: top7,
    mvpCount: mvpCount,
    leftCount: leftCount
  };
}
  
var HISTORY_LIMIT_KEY = "bf6_history_limit_v1";

function loadMatches() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    return [];
  }
}

function saveMatches(matches) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
}
  
  
/* ===== RANK SETTINGS (Valorant-like divisions) ===== */
var START_RP = 0;
var MIN_RP = 0;
var DIV_RR = 100;
var DIVS_PER_TIER = 3;

/*
IMPORTANT:
To have exactly 3 divisions per tier (III/II/I), each tier should span 300 RR.
So tier mins are spaced by 300.
This also makes ranking progression consistent and hard.
*/
var rankTiers = [
  { name: "OUTCAST",   color: "#ffb86b", min: 0   },
  { name: "THRALL",    color: "#22d3ee", min: 300 },
  { name: "MARAUDER",  color: "#38bdf8", min: 600 },
  { name: "HARBINGER", color: "#a78bfa", min: 900 },
  { name: "REAPER",    color: "#fb7185", min: 1200 },
  { name: "ARCHON",    color: "#fbbf24", min: 1500 },
  { name: "OVERLORD",  color: "#2dd4bf", min: 1800 },
  { name: "MONARCH",   color: "#60a5fa", min: 2100 },
  { name: "SERAPH",    color: "#e5e7eb", min: 2400 },
  { name: "EIDOLON",   color: "#ff3b3b", min: 2700 }
];

// cinematic tracking (tier + division)
var lastRankState = null; // { tierIndex, divIndex, label }

/* ===== RANK CALC ===== */
function getRank(totalRP) {
  // find tier index
  var tierIndex = 0;
  for (var i = 0; i < rankTiers.length; i++) {
    if (totalRP >= rankTiers[i].min) tierIndex = i;
  }

  var tier = rankTiers[tierIndex];

  // NEXUS special case
  if (tier.name === "EIDOLON") {
    return {
      label: "EIDOLON",
      tierName: "EIDOLON",
      tierIndex: tierIndex,
      div: null,
      divIndex: null,
      color: tier.color,
      rr: 100,
      nextMin: null
    };
  }

  var nextTier = rankTiers[tierIndex + 1];

  // RR inside this tier
  var rrInTier = totalRP - tier.min;
  if (rrInTier < 0) rrInTier = 0;

  // Division index (0..2) based on 100 RR chunks
  var divIndex = Math.floor(rrInTier / DIV_RR);
  if (divIndex < 0) divIndex = 0;
  if (divIndex > (DIVS_PER_TIER - 1)) divIndex = (DIVS_PER_TIER - 1);

  // RR progress inside current division (0..99)
  var rr = rrInTier - (divIndex * DIV_RR);
  if (rr < 0) rr = 0;
  if (rr > (DIV_RR - 1)) rr = (DIV_RR - 1);

  // Division label mapping: 0->III, 1->II, 2->I
  var div = (divIndex === 0) ? "III" : (divIndex === 1 ? "II" : "I");

  // Label
  var label = tier.name + " " + div;

  // Next threshold shown on UI
  var nextMin = null;
  if (divIndex === (DIVS_PER_TIER - 1)) nextMin = nextTier ? nextTier.min : null;
  else nextMin = tier.min + ((divIndex + 1) * DIV_RR);

  return {
    label: label,
    tierName: tier.name,
    tierIndex: tierIndex,
    div: div,
    divIndex: divIndex,
    color: tier.color,
    rr: rr, // 0..99
    nextMin: nextMin
  };
}

/* ===== BR RR FORMULA (hard to climb) ===== */
function calcRPBreakdown(m) {
  var place = Math.min(25, Math.max(1, Number(m.place || 25)));
  var kills = Math.max(0, Number(m.kills || 0));
  var assists = Math.max(0, Number(m.assists || 0));
  var deaths = Math.max(0, Number(m.deaths || 0));
  var mvp = !!m.mvp;
  var left = !!m.left;

  var contrib = kills + assists;

  // Contribution tiers
  var isLow = contrib < 5;
  var isNormal = contrib >= 5;
  var isHigh = (kills >= 10) || (contrib >= 20);

  // Placement base
  var placementBase = 0;
  if (place === 1) placementBase = 26;
  else if (place === 2) placementBase = 22;
  else if (place === 3) placementBase = 20;
  else if (place === 4) placementBase = 17;
  else if (place === 5) placementBase = 15;
  else if (place === 6) placementBase = 13;
  else if (place === 7) placementBase = 11;
  else if (place >= 8 && place <= 11) placementBase = 0;
  else if (place >= 12 && place <= 15) placementBase = -2;
  else if (place === 16) placementBase = -4;
  else if (place === 17) placementBase = -6;
  else if (place === 18) placementBase = -8;
  else if (place === 19) placementBase = -10;
  else if (place === 20) placementBase = -12;
  else if (place === 21) placementBase = -14;
  else if (place === 22) placementBase = -16;
  else if (place === 23) placementBase = -18;
  else if (place === 24) placementBase = -20;
  else placementBase = -22;

  // Placement modifier by contribution
  var placementMod = 0;
  if (place <= 7) {
    if (isHigh) placementMod = 2;
    else if (isNormal) placementMod = 1;
    else placementMod = 0;
  } else if (place >= 8 && place <= 11) {
    if (isHigh) placementMod = 3;
    else if (isNormal) placementMod = 2;
    else placementMod = 0;
  } else if (place >= 12 && place <= 15) {
    if (isHigh) placementMod = 3;        // -2 +3 = +1
    else if (isNormal) placementMod = 2;  // -2 +2 = 0
    else placementMod = -2;              // -2 -2 = -4
  } else {
    placementMod = 0; // place > 15: no mod
  }

  var placementScore = placementBase + placementMod;

  // Combat score (normalized & capped)
  var killScore = 0;
  var k1 = Math.min(kills, 5);
  var k2 = Math.min(Math.max(kills - 5, 0), 5);
  killScore += k1 * 2;
  killScore += k2 * 1;

  var assistScore = 0;
  var a1 = Math.min(assists, 5);
  var a2 = Math.min(Math.max(assists - 5, 0), 5);
  assistScore += a1 * 1;
  assistScore += a2 * 0.5;

  var deathScore = -2 * deaths;
  if (deathScore < -10) deathScore = -10;

  var combatScore = killScore + assistScore + deathScore;
  if (combatScore > 14) combatScore = 14;

  var mvpBonus = mvp ? 3 : 0;

  var leftBonus = 0;
  if (left) {
    if (place === 1) leftBonus = 10;
    else if (place <= 3) leftBonus = 7;
    else if (place <= 7) leftBonus = 4;
  }

  var total = placementScore + combatScore + mvpBonus + leftBonus;

  // Clamp final RR per match
  if (total > 32) total = 32;
  if (total < -25) total = -25;

  // Invalid-ish protection
  if (left && place > 15 && total < -8) total = -8;

  total = Math.round(total);

  return {
    place: place,
    contrib: contrib,
    placementBase: placementBase,
    placementMod: placementMod,
    placementScore: placementScore,
    killScore: killScore,
    assistScore: assistScore,
    deathScore: deathScore,
    combatScore: combatScore,
    mvpBonus: mvpBonus,
    leftBonus: leftBonus,
    total: total
  };
}

/* ===== CINEMATIC (V3) ===== */

function closeCinematic() {
  var el = document.getElementById("cinematic");
  if (!el) return;
  el.classList.remove("is-open");
  el.setAttribute("aria-hidden", "true");
}

function showCinematic(fromRank, toRank, isPromotion, changeType) {
  // changeType: "division" | "tier"
  var el = document.getElementById("cinematic");
  var title = document.getElementById("cinTitle");
  var sub = document.getElementById("cinSub");
  var badge = document.getElementById("cinBadgeImg");
  var rankText = document.getElementById("cinRankText");

  var card = document.querySelector("#cinematic .cin-card");
  var burst = document.querySelector("#cinematic .cin-burst");
  var rays = document.querySelector("#cinematic .cin-rays");
  var flash = document.querySelector("#cinematic .cin-flash");
  var shock = document.querySelector("#cinematic .cin-shockwave");
  var glowf = document.querySelector("#cinematic .cin-glowfield");
  var ring = document.querySelector("#cinematic .cin-badgeRing");

  if (!el || !title || !sub || !card) return;

  var mode = isPromotion ? "up" : "down";
  el.dataset.mode = mode;

  // Accent from tier color
  var toTier = getTierNameFromLabel(toRank);
  var accent = "#22d3ee";
  for (var i = 0; i < rankTiers.length; i++) {
    if (rankTiers[i].name === toTier) accent = rankTiers[i].color;
  }
  el.style.setProperty("--cin-accent", accent);

  // Text
  if (changeType === "tier") title.textContent = isPromotion ? "TIER UP" : "TIER DOWN";
  else title.textContent = isPromotion ? "DIVISION UP" : "DIVISION DOWN";

  sub.textContent = String(fromRank) + " → " + String(toRank);
  if (rankText) rankText.textContent = String(toRank);

  // Badge image
  if (badge) badge.src = "assets/ranks/" + getTierKeyFromLabel(toRank) + ".webp";

  // Open overlay
  if (window.__cinT) clearTimeout(window.__cinT);
  el.classList.add("is-open");
  el.setAttribute("aria-hidden", "false");

  // Timings (tier is longer + more epic)
  var durCard = (changeType === "tier") ? 780 : 520;
  var durFx = (changeType === "tier") ? 980 : 720;
  var closeAfter = (changeType === "tier") ? 2800 : 1700;

  // Easing presets
  var easeInOut = "cubic-bezier(.2,.9,.2,1)";
  var easeOut = "cubic-bezier(.12,.92,.18,1)";

  // -----------------
  // CARD TIMELINE
  // -----------------
  // Promotion: stronger "lift + impact"
  // Demotion: slight "drop + heavier settle"
  var cardStartY = isPromotion ? 30 : -14;
  var cardMidY = isPromotion ? 6 : 10;
  var cardImpactY = isPromotion ? -4 : 4;
  var cardScaleStart = isPromotion ? 0.94 : 0.98;

  card.animate([
    { opacity: 0, transform: "translate3d(0," + cardStartY + "px,0) scale(" + cardScaleStart + ")" },
    { opacity: 1, transform: "translate3d(0," + cardMidY + "px,0) scale(0.985)", offset: 0.34 },
    { opacity: 1, transform: "translate3d(0," + cardImpactY + "px,0) scale(1.03)", offset: 0.62 },
    { opacity: 1, transform: "translate3d(0,0,0) scale(1)" }
  ], { duration: durCard, easing: easeInOut, fill: "forwards" });

  // Tier-up: micro shake for impact (transform only, no lag)
  if (changeType === "tier" && isPromotion) {
    card.animate([
      { transform: "translate3d(0,0,0)" },
      { transform: "translate3d(-7px,0,0)", offset: 0.12 },
      { transform: "translate3d(7px,0,0)", offset: 0.24 },
      { transform: "translate3d(-4px,0,0)", offset: 0.36 },
      { transform: "translate3d(0,0,0)" }
    ], { duration: 420, easing: "ease-out", fill: "none", delay: 260 });
  }

  // -----------------
  // BADGE POP
  // -----------------
  if (badge) {
    badge.animate([
      { opacity: 0, transform: "translate3d(0,16px,0) scale(0.84)" },
      { opacity: 1, transform: "translate3d(0,2px,0) scale(0.98)", offset: 0.34 },
      { opacity: 1, transform: "translate3d(0,-2px,0) scale(1.10)", offset: 0.62 },
      { opacity: 1, transform: "translate3d(0,0,0) scale(1)" }
    ], { duration: durCard, delay: 120, easing: easeOut, fill: "forwards" });
  }

  // Ring subtle spin (cheap)
  if (ring) {
    ring.animate([
      { opacity: 0.85, transform: "rotate(0deg)" },
      { opacity: 1.0, transform: "rotate(120deg)" },
      { opacity: 0.9, transform: "rotate(220deg)" }
    ], { duration: durFx, easing: "linear", fill: "forwards" });
  }

  // -----------------
  // FX: Burst / Rays / Flash
  // -----------------
  if (burst) {
    burst.animate([
      { opacity: 0, transform: "scale(0.90)" },
      { opacity: (isPromotion ? 0.9 : 0.55), transform: "scale(1.05)", offset: 0.42 },
      { opacity: 0.22, transform: "scale(1.00)" }
    ], { duration: durFx, easing: "ease-out", fill: "forwards" });
  }

  if (rays) {
    rays.animate([
      { opacity: 0, transform: "scale(0.96) rotate(0deg)" },
      { opacity: (isPromotion ? 0.65 : 0.35), transform: "scale(1.03) rotate(12deg)", offset: 0.45 },
      { opacity: 0.14, transform: "scale(1.00) rotate(18deg)" }
    ], { duration: durFx, easing: "ease-out", fill: "forwards" });
  }

  // Flash is only for tier changes (big moment)
  if (flash) {
    var flashPeak = (changeType === "tier") ? (isPromotion ? 0.55 : 0.28) : 0.0;
    flash.animate([
      { opacity: 0 },
      { opacity: flashPeak, offset: 0.35 },
      { opacity: 0.0 }
    ], { duration: (changeType === "tier" ? 680 : 1), easing: "ease-out", fill: "forwards", delay: 110 });
  }
// -----------------
// EPIC MOMENT (Tier only)
// -----------------
if (changeType === "tier") {
  // Glowfield "charge"
  if (glowf) {
    glowf.animate([
      { opacity: 0, transform: "scale(0.95)" },
      { opacity: 0.55, transform: "scale(1.03)", offset: 0.45 },
      { opacity: 0.18, transform: "scale(1.00)" }
    ], { duration: 1100, easing: "ease-out", fill: "forwards" });
  }

  // Shockwave "impact"
  if (shock) {
    shock.animate([
      { opacity: 0, transform: "scale(0.25)" },
      { opacity: 0.55, transform: "scale(0.55)", offset: 0.25 },
      { opacity: 0.22, transform: "scale(1.10)", offset: 0.65 },
      { opacity: 0.0, transform: "scale(1.35)" }
    ], { duration: 900, easing: "cubic-bezier(.1,.9,.2,1)", fill: "forwards", delay: 120 });
  }

  // Extra badge "power punch" (small, no lag)
  if (badge) {
    badge.animate([
      { transform: "scale(1)" },
      { transform: "scale(1.14)", offset: 0.35 },
      { transform: "scale(1.00)" }
    ], { duration: 520, easing: "cubic-bezier(.2,.9,.2,1)", fill: "forwards", delay: 340 });
  }
}
  // Auto-close
  window.__cinT = setTimeout(function () {
    el.classList.remove("is-open");
    el.setAttribute("aria-hidden", "true");
  }, closeAfter);
}

// Close UX: Esc + click on backdrop
document.addEventListener("keydown", function(e){
  if (e.key === "Escape") closeCinematic();
});

document.addEventListener("click", function(e){
  var el = document.getElementById("cinematic");
  if (!el || !el.classList.contains("is-open")) return;

  // Close only if clicking background/root (not the card)
  var t = e.target;
  var bg = t && t.classList && t.classList.contains("cinematic-bg");
  var root = t === el;
  if (bg || root) closeCinematic();
});

/* ===== LADDER UI ===== */
function updateLadderUI(currentTierIndex) {
  var items = document.querySelectorAll(".ladder-list .ladder-item");

  for (var i = 0; i < items.length; i++) {
    var item = items[i];

    // State classes
    item.classList.remove("locked", "unlocked", "current");
    if (i < currentTierIndex) item.classList.add("unlocked");
    else if (i === currentTierIndex) item.classList.add("unlocked", "current");
    else item.classList.add("locked");

    // Badge image from rankTiers (reliable)
    var badgeEl = item.querySelector(".badge");
    if (badgeEl && rankTiers[i] && rankTiers[i].name) {
      var tierKey = String(rankTiers[i].name).toLowerCase();

      // Force override ANY existing gradient backgrounds
      badgeEl.style.background = 'url("assets/ranks/' + tierKey + '.webp") center / contain no-repeat';
    }
  }
}

/* ===== UI UPDATES ===== */
function updateRankUI(matchesAll) {
  // Backfill breakdown for old matches
  for (var bi = 0; bi < matchesAll.length; bi++) {
    if (!matchesAll[bi].breakdown) {
      matchesAll[bi].breakdown = calcRPBreakdown(matchesAll[bi]);
      matchesAll[bi].rp = matchesAll[bi].breakdown.total;
    }
  }

  var sum = 0;
  for (var i = 0; i < matchesAll.length; i++) sum += Number(matchesAll[i].rp || 0);

  var totalRP = START_RP + sum;
  if (totalRP < MIN_RP) totalRP = MIN_RP;

  var rank = getRank(totalRP);
   // ===== Player Hub header bindings (safe) =====
  var hub = document.querySelector("#dashboard");
  if (hub) hub.style.setProperty("--hub-accent", rank.color);

  var phRankLabel = document.getElementById("phRankLabel");
  var phRRText = document.getElementById("phRRText");
  var phProgressFill = document.getElementById("phProgressFill");
  // ===== Player Hub emblem (webp main + png fallback) =====
  var phBadgeImg = document.getElementById("phBadgeImg");

  if (phBadgeImg && rank.tierName) {
    var key = String(rank.tierName).toLowerCase(); // "overlord", "monarch", etc

    // MAIN: webp
    phBadgeImg.src = "assets/ranks/" + key + ".webp";

    // Fallback: png (only if webp fails)
    phBadgeImg.onerror = function () {
      this.onerror = null; // prevent loop
      this.src = "assets/master/" + key + ".png";
    };

    // Normalize scale per rank (so icons don't "jump")
    var hub = document.querySelector("#dashboard");
    if (hub) {
      var scale = 0.78; // base
      if (key === "monarch") scale = 0.82;
      if (key === "seraph") scale = 0.76;
      if (key === "eidolon") scale = 0.80;
      if (key === "outcast") scale = 0.74;
      hub.style.setProperty("--icon-scale", String(scale));
    }
  }

  if (phRankLabel) phRankLabel.textContent = rank.label;

  if (phRRText) {
    phRRText.textContent = (rank.tierName === "EIDOLON")
      ? ("RR: " + totalRP + " (MAX)")
      : ("RR: " + totalRP + " / " + rank.nextMin);
  }

  if (phProgressFill) {
    var pctPH = Math.round((rank.rr / (DIV_RR - 1)) * 100);
    phProgressFill.style.width = pctPH + "%";
  }

  var hud = document.getElementById("rankTierHUD");
if (hud) {
  var dots = hud.querySelectorAll(".tierHUD__dot");
  dots.forEach(d => d.classList.remove("is-on"));
  if (rank.tierName === "EIDOLON") {
    hud.style.display = "none";
  } else {
    hud.style.display = "flex";
    var onCount = (rank.divIndex != null) ? (rank.divIndex + 1) : 0; // 0->1,1->2,2->3
    for (var i=0;i<onCount && i<dots.length;i++) dots[i].classList.add("is-on");
  }
}

  // Rank card elements (IDs preferred)
  var rankTitle = document.getElementById("rankCardTitle") || document.querySelector("#rank .rank-info h2");
  var rankRP = document.getElementById("rankCardRP") || document.querySelector("#rank .rank-rp");
  var rpFill = document.getElementById("rankCardFill") || document.querySelector("#rank .rp-fill");
  var chip = document.getElementById("rankCardChip");
  var icon = document.getElementById("rankCardIcon");

  if (rankTitle) rankTitle.textContent = rank.label;
  // Rank badge image
const badgeImg = document.getElementById("rankBadgeImg");
if (badgeImg && rank.tierName) {
  const tierKey = rank.tierName.toLowerCase();
  badgeImg.src = "assets/ranks/" + tierKey + ".webp";
}

  if (rankRP) {
    if (rank.tierName === "EIDOLON") rankRP.textContent = "RR: " + totalRP + " (MAX)";
    else rankRP.textContent = "RR: " + totalRP + " / " + rank.nextMin;
  }

  if (rpFill) {
    var pct = Math.round((rank.rr / (DIV_RR - 1)) * 100);
    rpFill.style.width = String(pct) + "%";
  }

  if (chip) {
    chip.textContent = rank.tierName === "EIDOLON" ? "ABSOLUTE PEAK" : ("TIER: " + rank.tierName);
  }
  if (icon) {
    icon.style.setProperty("--rank-accent", rank.color);
  }

  updateLadderUI(rank.tierIndex);

  // Dashboard
  var dash = document.querySelector("#dashboard .panel");
  if (dash) {
    dash.innerHTML =
      "<p>🔹 Current RR: <strong>" + totalRP + "</strong></p>" +
      "<p>🔹 Current Rank: <strong>" + rank.label + "</strong></p>" +
      "<p>🔹 Matches: <strong>" + matchesAll.length + "</strong></p>";
  }

  // Cinematic trigger (tier + division)
var currentState = { tierIndex: rank.tierIndex, divIndex: rank.divIndex, label: rank.label };

if (lastRankState === null) {
  lastRankState = currentState;
} else {
  var tierChanged = currentState.tierIndex !== lastRankState.tierIndex;
  var divChanged = currentState.divIndex !== lastRankState.divIndex;

  if (tierChanged) {
    var promotedTier = currentState.tierIndex > lastRankState.tierIndex;

    if (typeof window.showRankUp === "function") {
      window.showRankUp({
        fromText: lastRankState.label,
        toText: currentState.label,
        rrText: promotedTier ? "NEW RANK UNLOCKED" : "RANK DOWN"
      });
    }

    lastRankState = currentState;
  } else if (divChanged) {
    var a = (currentState.divIndex === null || currentState.divIndex === undefined) ? 0 : currentState.divIndex;
    var b = (lastRankState.divIndex === null || lastRankState.divIndex === undefined) ? 0 : lastRankState.divIndex;
    var promotedDiv = a > b;

    if (typeof window.showTierUp === "function") {
      window.showTierUp({
  fromText: lastRankState.label,
  toText: currentState.label,
  rrText: promotedDiv ? "TIER UPGRADED" : "TIER DOWNGRADED",
  divIndex: currentState.divIndex
      });
    }

    lastRankState = currentState;
    }
  }
}

function getHistoryLimit() {
  // "20" or "all"
  var v = localStorage.getItem(HISTORY_LIMIT_KEY);
  return v ? v : "20";
}

function setHistoryLimit(val) {
  localStorage.setItem(HISTORY_LIMIT_KEY, val);
}
  
function renderHistoryFromStorage() {
  var matchesAll = loadMatches();
  // Backfill matchId for legacy matches
var changedId = false;
for (var mi = 0; mi < matchesAll.length; mi++) {
  if (!matchesAll[mi].matchId) {
    matchesAll[mi].matchId = genMatchId(matchesAll[mi].ts || Date.now());
    changedId = true;
  }
}
if (changedId) saveMatches(matchesAll);
  
  ensureSeasonSystem();
  
  

var activeSeasonId = getActiveSeasonId();
var selectedSeasonId = getSelectedSeasonId();

// Build two views: active (for Rank) and selected (for History)
var activeMatchesAll = [];
var selectedMatchesAll = [];

for (var fi = 0; fi < matchesAll.length; fi++) {
  // If old match has no seasonId, assign to active season (legacy)
  if (!matchesAll[fi].seasonId) matchesAll[fi].seasonId = activeSeasonId;

  if (matchesAll[fi].seasonId === activeSeasonId) activeMatchesAll.push(matchesAll[fi]);
  if (matchesAll[fi].seasonId === selectedSeasonId) selectedMatchesAll.push(matchesAll[fi]);
}

// Persist possible legacy patch
saveMatches(matchesAll);

// From now on:
// - use activeMatchesAll for Rank UI
// - use selectedMatchesAll for History list & stats
  
  // Build season dropdown
var seasons = loadSeasons();
var activeId = getActiveSeasonId();
var select = document.getElementById("seasonSelect");

if (select) {
  select.innerHTML = "";
  for (var si = seasons.length - 1; si >= 0; si--) {
    var s = seasons[si];
    var opt = document.createElement("option");
    var label = (s.name ? s.name : s.id);
    label += " [" + s.id + "]";

    if (s.id === activeId) label += " (Active)";
    if (s.finalRankLabel) label += " • " + s.finalRankLabel;

    opt.value = s.id;
    opt.textContent = label;

    select.appendChild(opt);
  }

  select.value = selectedSeasonId || activeId;
}
  // Read-only mode indicator (History viewing non-active season)
var ro = document.getElementById("readOnlyBadge");
var isReadOnly = (selectedSeasonId !== activeSeasonId);
if (ro) ro.style.display = isReadOnly ? "inline-block" : "none";

// Disable destructive season actions when read-only (optional UX)
var renameBtn = document.querySelector('button[onclick="renameSeason()"]');
var deleteBtn = document.querySelector('button[onclick="deleteSeason()"]');
if (renameBtn) renameBtn.disabled = false; // allow rename anytime (your choice)
if (deleteBtn) deleteBtn.disabled = false; // delete already has safety checks

// If you want to block rename/delete while viewing non-active season, uncomment:
// if (renameBtn) renameBtn.disabled = isReadOnly;
// if (deleteBtn) deleteBtn.disabled = isReadOnly;
  
  // Render season summary panel (selected season)
var summaryEl = document.getElementById("seasonSummary");
if (summaryEl) {
  var seasonsList = loadSeasons();
  var selectedMeta = null;
  for (var si = 0; si < seasonsList.length; si++) {
    if (seasonsList[si].id === selectedSeasonId) selectedMeta = seasonsList[si];
  }

  var isActive = (selectedSeasonId === activeSeasonId);

  // Compute current RR/rank for selected season (even if ended, for display consistency)
  var sumRR = 0;
  for (var mi = 0; mi < selectedMatchesAll.length; mi++) sumRR += Number(selectedMatchesAll[mi].rp || 0);
  var currentRR = START_RP + sumRR;
  if (currentRR < MIN_RP) currentRR = MIN_RP;
  var currentRank = getRank(currentRR);

  var stats = computeSeasonStats(selectedMatchesAll);

  var html = "";
  html += "<div class='row'><div class='k'>Season</div><div class='v'>" +
          selectedSeasonId + " " + (isActive ? "<span class='season-tag active'>Active</span>" : "<span class='season-tag'>Ended</span>") +
          "</div></div>";

  html += "<div class='row'><div class='k'>Current Rank</div><div class='v'>" + currentRank.label + "</div></div>";
  html += "<div class='row'><div class='k'>Current RR</div><div class='v'>" + currentRR + "</div></div>";

  if (selectedMeta && !isActive) {
    if (selectedMeta.finalRankLabel) {
      html += "<div class='row'><div class='k'>Final Rank</div><div class='v'>" + selectedMeta.finalRankLabel + "</div></div>";
    }
    if (selectedMeta.finalRR !== null && selectedMeta.finalRR !== undefined) {
      html += "<div class='row'><div class='k'>Final RR</div><div class='v'>" + selectedMeta.finalRR + "</div></div>";
    }
  }

  html += "<div class='row'><div class='k'>Matches</div><div class='v'>" + stats.matchesCount + "</div></div>";
  html += "<div class='row'><div class='k'>Avg RR / match</div><div class='v'>" + stats.avgRR + "</div></div>";
  html += "<div class='row'><div class='k'>Best / Worst</div><div class='v'>" + (stats.bestRR >= 0 ? "+" + stats.bestRR : stats.bestRR) +
          " / " + (stats.worstRR >= 0 ? "+" + stats.worstRR : stats.worstRR) + "</div></div>";
  html += "<div class='row'><div class='k'>Top1 / Top3 / Top7</div><div class='v'>" +
          stats.top1Count + " / " + stats.top3Count + " / " + stats.top7Count + "</div></div>";
  html += "<div class='row'><div class='k'>MVP</div><div class='v'>" + stats.mvpCount + "</div></div>";
  html += "<div class='row'><div class='k'>Teammate Left</div><div class='v'>" + stats.leftCount + "</div></div>";

  summaryEl.innerHTML = html;
}

  // Backfill + recalc rp with current formula
  var changed = false;
  for (var i = 0; i < matchesAll.length; i++) {
    matchesAll[i].breakdown = calcRPBreakdown(matchesAll[i]);
    matchesAll[i].rp = matchesAll[i].breakdown.total;
    changed = true;
  }
  if (changed) saveMatches(matchesAll);

  updateRankUI(activeMatchesAll);
  // ===== Player Hub snapshot (ACTIVE season) =====
  var statsHub = computeSeasonStats(activeMatchesAll);

  var elMatches = document.getElementById("phMatches");
  var elMatches2 = document.getElementById("phMatches2");
  var elStreak = document.getElementById("phStreak");
  var elAvg = document.getElementById("phAvg");
  var elBest = document.getElementById("phBest");
  var elWorst = document.getElementById("phWorst");

  if (elMatches) elMatches.textContent = String(statsHub.matchesCount);
  if (elMatches2) elMatches2.textContent = String(statsHub.matchesCount);

  if (elAvg) elAvg.textContent = String(statsHub.avgRR);
  if (elBest) elBest.textContent = (statsHub.bestRR >= 0 ? ("+" + statsHub.bestRR) : String(statsHub.bestRR));
  if (elWorst) elWorst.textContent = String(statsHub.worstRR);

  // streak = Top-3 streak (newest backwards)
  var sortedActiveHub = activeMatchesAll.slice().sort(function(a,b){
    return Number(b.ts || 0) - Number(a.ts || 0);
  });
  var streakHub = 0;
  for (var si=0; si<sortedActiveHub.length; si++){
    if (Number(sortedActiveHub[si].place || 99) <= 3) streakHub++;
    else break;
  }
  if (elStreak) elStreak.textContent = String(streakHub);

  // recent matches feed
  var phRecent = document.getElementById("phRecent");
  if (phRecent){
    phRecent.innerHTML = "";
    var top = sortedActiveHub.slice(0, 5);

    if (top.length === 0){
      var empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No matches yet — add your first match to start tracking.";
      phRecent.appendChild(empty);
    } else {
      for (var j=0; j<top.length; j++){
        var m = top[j];
        var row = document.createElement("div");
        row.className = "feedRow";

        var delta = Number(m.rp || 0);
        var deltaClass = (delta >= 0) ? "pos" : "neg";
        var deltaText = (delta >= 0) ? ("+" + delta) : String(delta);

        row.innerHTML =
          "<div class='feedLeft'>" +
            "<div class='feedTop'>Match • Place " + m.place + " / 25</div>" +
            "<div class='feedSub'>K/A/D: " + m.kills + "/" + m.assists + "/" + m.deaths +
              " • " + new Date(Number(m.ts||0)).toLocaleString() + "</div>" +
          "</div>" +
          "<div class='feedDelta " + deltaClass + "'>" + deltaText + "</div>";

        phRecent.appendChild(row);
      }
    }
  }

  // Display list: newest first, last 20
  var matches = selectedMatchesAll.slice();
  matches.sort(function(a, b) { return Number(b.ts || 0) - Number(a.ts || 0); });

  var mode = getHistoryLimit(); // "20" or "all"
var MAX_MATCHES = (mode === "all") ? 0 : 20;

if (MAX_MATCHES > 0 && matches.length > MAX_MATCHES) matches = matches.slice(0, MAX_MATCHES);

// Update UI label/button
var toggleBtn = document.getElementById("toggleHistoryBtn");
var hint = document.getElementById("historyHint");
if (toggleBtn) toggleBtn.textContent = (mode === "all") ? "Show last 20" : "Show all";
if (hint) hint.textContent = (mode === "all") ? ("Showing all matches (" +selectedMatchesAll.length + ")") : "Showing last 20 matches";

  var list = document.getElementById("matchList");
  if (!list) return;
  list.innerHTML = "";

  var streakEl = document.getElementById("streakValue");
  var bestEl = document.getElementById("bestValue");
  var worstEl = document.getElementById("worstValue");

  if (selectedMatchesAll.length === 0) {
    var panel = document.createElement("div");
    panel.className = "panel";
    var p = document.createElement("p");
    p.innerHTML = 'No matches yet. Add your first match in <b>ADD MATCH</b>.';
    panel.appendChild(p);
    list.appendChild(panel);

    if (streakEl) streakEl.textContent = "0";
    if (bestEl) bestEl.textContent = "+0";
    if (worstEl) worstEl.textContent = "0";
    return;
  }

  // Best / worst across ALL matches
  var best = -Infinity;
  var worst = Infinity;
  for (var b = 0; b < selectedMatchesAll.length; b++) {
    var rp = Number(selectedMatchesAll[b].rp || 0);
    if (rp > best) best = rp;
    if (rp < worst) worst = rp;
  }
  if (bestEl) bestEl.textContent = best >= 0 ? ("+" + best) : String(best);
  if (worstEl) worstEl.textContent = String(worst);

  // Streak across ALL matches (place <= 3), newest backwards by ts
  var sortedAll = selectedMatchesAll.slice().sort(function(a, b) { return Number(b.ts || 0) - Number(a.ts || 0); });
  var streak = 0;
  for (var s = 0; s < sortedAll.length; s++) {
    if (Number(sortedAll[s].place || 99) <= 3) streak++;
    else break;
  }
  if (streakEl) streakEl.textContent = String(streak);

  // Render visible cards
  for (var idx = 0; idx < matches.length; idx++) {
    var m = matches[idx];

    var card = document.createElement("div");
    card.className = "match-card";
    if (m.rp === best) card.classList.add("best");
    if (m.rp === worst) card.classList.add("worst");

    var row = document.createElement("div");
    row.className = "match-row";

    var left = document.createElement("div");
    left.className = "left";

    var title = document.createElement("div");
    title.className = "title";

    var matchNum = document.createElement("span");
    matchNum.textContent = "Match #" + (idx + 1);
    title.appendChild(matchNum);

    var badges = document.createElement("div");
    badges.className = "badges";

    if (m.mvp) {
      var b1 = document.createElement("span");
      b1.className = "badge-pill badge-mvp";
      b1.textContent = "⭐ MVP";
      badges.appendChild(b1);
    }
    if (m.left) {
      var b2 = document.createElement("span");
      b2.className = "badge-pill badge-leave";
      b2.textContent = "⚠ Teammate Left";
      badges.appendChild(b2);
    }
    title.appendChild(badges);

    var place = document.createElement("div");
    place.className = "place";
    place.innerHTML = "🏆 Place: <strong>" + m.place + "</strong> / 25 teams";

    var kad = document.createElement("div");
    kad.className = "kad";
    kad.innerHTML =
      "🔫 K/A/D: <strong>" + m.kills + "</strong> / <strong>" + m.assists + "</strong> / <strong>" + m.deaths + "</strong>";

    left.appendChild(title);
    left.appendChild(place);
    var time = document.createElement("div");
    time.className = "kad";
    time.textContent = "🕒 " + new Date(Number(m.ts || 0)).toLocaleString();
    left.appendChild(time);
    left.appendChild(kad);

    var rpDelta = document.createElement("div");
    rpDelta.className = "rpDelta " + (m.rp >= 0 ? "rpPlus" : "rpMinus");
    rpDelta.textContent = (m.rp >= 0 ? "+" + m.rp : String(m.rp)) + " RR";

    row.appendChild(left);
    row.appendChild(rpDelta);
    
    

    card.appendChild(row);
    list.appendChild(card);
  }
}
  

  function clampInt(value, min, max, fallback) {
  var n = Number(value);
  if (!isFinite(n)) n = (fallback !== undefined) ? fallback : min;
  n = Math.floor(n);
  if (n < min) n = min;
  if (n > max) n = max;
  return n;
}
  
/* ===== ACTIONS ===== */
function startNewSeason() {
  ensureSeasonSystem();

  var seasons = loadSeasons();
  var activeId = getActiveSeasonId();

  // Compute final stats for active season
  var allMatches = loadMatches();
  var activeMatches = [];
  for (var i = 0; i < allMatches.length; i++) {
    if (allMatches[i].seasonId === activeId) activeMatches.push(allMatches[i]);
  }

  // Final RR for season = START_RP + sum(rr)
  var sum = 0;
  for (var j = 0; j < activeMatches.length; j++) sum += Number(activeMatches[j].rp || 0);
  var finalRR = START_RP + sum;
  if (finalRR < MIN_RP) finalRR = MIN_RP;

  var finalRank = getRank(finalRR);

  // Close current season
  for (var s = 0; s < seasons.length; s++) {
    if (seasons[s].id === activeId) {
      seasons[s].endAt = Date.now();
      seasons[s].finalRR = finalRR;
      seasons[s].finalRankLabel = finalRank.label;
      seasons[s].stats = computeSeasonStats(activeMatches);
    }
  }

  // Create next season id based on max existing S#
var maxNum = 0;
for (var x = 0; x < seasons.length; x++) {
  var m = String(seasons[x].id || "").match(/^S(\d+)$/);
  if (m) {
    var n = Number(m[1]);
    if (n > maxNum) maxNum = n;
  }
}
var newId = "S" + (maxNum + 1);

  seasons.push({
  id: newId,
  name: newId,
  startAt: Date.now(),
  endAt: null,
  finalRR: null,
  finalRankLabel: null,
  stats: null
});

  saveSeasons(seasons);
  setActiveSeasonId(newId);
  setSelectedSeasonId(newId);

  lastRankState = null;
  renderHistoryFromStorage();

  alert("New season started! RR has been reset for the active season.");
}
  
  function clampNumber(val, min, max, fallback) {
  val = Number(val);
  if (!isFinite(val)) return fallback;
  if (val < min) return min;
  if (val > max) return max;
  return val;
}
  
  function genMatchId(ts) {
  // Unique-enough ID without crypto dependency
  var r = Math.random().toString(16).slice(2);
  return "m_" + String(ts) + "_" + r;
}
  
  function enforceActiveSeasonContext() {
  ensureSeasonSystem();

  var activeId = getActiveSeasonId();
  var selectedId = getSelectedSeasonId();

  if (selectedId && activeId && selectedId !== activeId) {
    setSelectedSeasonId(activeId);
    return false;
  }
  return true;
}
  
  function submitMatch() {
    // Lock RP: prevent adding match while viewing past season
  var okSeason = enforceActiveSeasonContext();
  if (!okSeason) {
    showToast("Switched back to ACTIVE season. Please submit again.", "warn");
    renderHistoryFromStorage();
    return;
  }
   
  const place = clampNumber(document.getElementById("inPlace").value, 1, 25, 25);
  const kills = clampNumber(document.getElementById("inKills").value, 0, 99, 0);
  const assists = clampNumber(document.getElementById("inAssists").value, 0, 99, 0);
  const deaths = clampNumber(document.getElementById("inDeaths").value, 0, 99, 0);
  var mvp = document.getElementById("inMVP").checked;
  var left = document.getElementById("inLeft").checked;
  document.getElementById("inPlace").value = place;
  document.getElementById("inKills").value = kills;
  document.getElementById("inAssists").value = assists;
  document.getElementById("inDeaths").value = deaths;

  var ts = Date.now();
    
  var match = { place: place, kills: kills, assists: assists, deaths: deaths, mvp: mvp, left: left, ts: ts, seasonId: getActiveSeasonId(), matchId: genMatchId(ts) };
  match.breakdown = calcRPBreakdown(match);
  match.rp = match.breakdown.total;

  var matches = loadMatches();
  matches.push(match);
  saveMatches(matches);
    document.getElementById("inKills").value = 0;
    document.getElementById("inAssists").value = 0;
    document.getElementById("inDeaths").value = 1;
    document.getElementById("inMVP").checked = false;
    document.getElementById("inLeft").checked = false;

  renderHistoryFromStorage();

  var btns = document.querySelectorAll(".nav-btn");
  showTab("history", btns[2]);
}

function undoLastMatch() {
  ensureSeasonSystem();

  var activeSeasonId = getActiveSeasonId();
  var matches = loadMatches();

  if (!matches || matches.length === 0) {
    alert("No matches to undo.");
    return;
  }

  // Find newest match ONLY in active season
  var newestIndex = -1;
  var newestTs = -Infinity;

  for (var i = 0; i < matches.length; i++) {
    if (matches[i].seasonId !== activeSeasonId) continue;

    var ts = Number(matches[i].ts || 0);
    if (ts > newestTs) {
      newestTs = ts;
      newestIndex = i;
    }
  }

  if (newestIndex === -1) {
    alert("No matches to undo in the active season.");
    return;
  }

  matches.splice(newestIndex, 1);
  saveMatches(matches);

  lastRankState = null;
  renderHistoryFromStorage();

  var btns = document.querySelectorAll(".nav-btn");
  showTab("history", btns[2]);
}

function resetMatches() {
  if (!confirm("Reset all saved matches?")) return;
  localStorage.removeItem(STORAGE_KEY);
  lastRankState = null;
  renderHistoryFromStorage();
}

  document.addEventListener("click", function(e){
  var t = e.target;
  if (t && t.id === "toggleHistoryBtn") {
    var mode = getHistoryLimit();
    setHistoryLimit(mode === "all" ? "20" : "all");
    renderHistoryFromStorage();
  }
});
  
  document.addEventListener("change", function(e){
  var t = e.target;
  if (t && t.id === "seasonSelect") {
    setSelectedSeasonId(t.value);
    lastRankState = null;
    ensureSeasonSystem();
    renderHistoryFromStorage();
  }
});
function exportData() {
  ensureSeasonSystem();

  var box = document.getElementById("ioBox");

  var payload = {
    version: 2,
    exportedAt: Date.now(),
    seasons: loadSeasons(),
    activeSeasonId: getActiveSeasonId(),
    selectedSeasonId: getSelectedSeasonId(),
    matches: loadMatches()
  };

  var json = JSON.stringify(payload, null, 2);
  if (box) box.value = json;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(json).then(function () {
      alert("Exported! Full data copied to clipboard.");
    }).catch(function () {
      alert("Exported! (Clipboard copy was blocked by browser.)");
    });
  } else {
    alert("Exported! (Clipboard API not available.)");
  }
}

function importData() {
  ensureSeasonSystem();

  var box = document.getElementById("ioBox");
  if (!box) {
    alert("Import box not found.");
    return;
  }

  var text = String(box.value || "").trim();
  if (!text) {
    alert("Paste JSON into the box first.");
    return;
  }

  var payload;
  try {
    payload = JSON.parse(text);
  } catch (e) {
    alert("Invalid JSON. Please check formatting.");
    return;
  }

  var seasons = null;
  var activeId = null;
  var selectedId = null;
  var matches = null;

  if (payload && payload.version === 2) {
    seasons = Array.isArray(payload.seasons) ? payload.seasons : null;
    activeId = payload.activeSeasonId;
    selectedId = payload.selectedSeasonId;
    matches = Array.isArray(payload.matches) ? payload.matches : null;
  } else if (Array.isArray(payload)) {
    matches = payload;
  } else if (payload && Array.isArray(payload.matches)) {
    matches = payload.matches;
  }

  if (!matches) {
    alert("Unsupported format. Must be v2 export or { matches: [...] }");
    return;
  }

  if (!seasons || seasons.length === 0 || !activeId) {
    // legacy import: create single season
    activeId = "S1";
    seasons = [{
      id: activeId,
      startAt: Date.now(),
      endAt: null,
      finalRR: null,
      finalRankLabel: null,
      stats: null
    }];
    selectedId = activeId;
  }

  // Clean + normalize matches (ensure seasonId, ts, rp/breakdown)
  var cleaned = [];
  for (var i = 0; i < matches.length; i++) {
    var m = matches[i] || {};

    var place = clampInt(m.place, 1, 25, 25);
    var kills = clampInt(m.kills, 0, 99, 0);
    var assists = clampInt(m.assists, 0, 99, 0);
    var deaths = clampInt(m.deaths, 0, 99, 0);
    var mvp = !!m.mvp;
    var left = !!m.left;
    var ts = Number(m.ts || Date.now());
    var seasonId = m.seasonId ? String(m.seasonId) : String(activeId);

    if (!isFinite(place)) place = 25;
    if (!isFinite(kills)) kills = 0;
    if (!isFinite(assists)) assists = 0;
    if (!isFinite(deaths)) deaths = 0;
    if (!isFinite(ts)) ts = Date.now();

    var obj = {
      place: place,
      kills: kills,
      assists: assists,
      deaths: deaths,
      mvp: mvp,
      left: left,
      ts: ts,
      seasonId: seasonId
    };

    obj.breakdown = calcRPBreakdown(obj);
    obj.rp = obj.breakdown.total;

    cleaned.push(obj);
  }
  
  makeBackup("before import");
  if (!confirm("Import will replace your current saved data (seasons + matches). Continue?")) return;

  saveMatches(cleaned);
  saveSeasons(seasons);

  setActiveSeasonId(activeId);

  var validSelected = false;
  for (var s = 0; s < seasons.length; s++) {
    if (seasons[s].id === selectedId) validSelected = true;
  }
  setSelectedSeasonId(validSelected ? selectedId : activeId);

  lastRankState = null;
  renderHistoryFromStorage();

  var btns = document.querySelectorAll(".nav-btn");
  showTab("history", btns[2]);

  alert("Import complete!");
}

function clearIO() {
  var box = document.getElementById("ioBox");
  if (box) box.value = "";
}
  function renameSeason() {
  ensureSeasonSystem();

  var seasons = loadSeasons();
  var selectedId = getSelectedSeasonId();

  var season = null;
  for (var i = 0; i < seasons.length; i++) {
    if (seasons[i].id === selectedId) season = seasons[i];
  }
  if (!season) {
    alert("Season not found.");
    return;
  }

  var currentName = season.name || season.id;
  var next = prompt("Enter season name:", currentName);
  if (next === null) return;

  next = String(next).trim();
  if (!next) {
    alert("Name cannot be empty.");
    return;
  }
  if (next.length > 40) {
    alert("Name too long (max 40 chars).");
    return;
  }

  season.name = next;
  saveSeasons(seasons);
  renderHistoryFromStorage();
}

function deleteSeason() {
  ensureSeasonSystem();

  var seasons = loadSeasons();
  var selectedId = getSelectedSeasonId();
  var activeId = getActiveSeasonId();

  if (selectedId === activeId) {
    alert("You can't delete the active season. Start a new season first, then delete the old one.");
    return;
  }

  // Only allow deleting ended seasons (safety)
  var season = null;
  for (var i = 0; i < seasons.length; i++) {
    if (seasons[i].id === selectedId) season = seasons[i];
  }
  if (!season) {
    alert("Season not found.");
    return;
  }
  if (!season.endAt) {
    alert("You can only delete ended seasons.");
    return;
  }

  if (!confirm("Delete season " + selectedId + " and all its matches? This cannot be undone.")) return;

  // Remove season
  var nextSeasons = [];
  for (var s = 0; s < seasons.length; s++) {
    if (seasons[s].id !== selectedId) nextSeasons.push(seasons[s]);
  }
  saveSeasons(nextSeasons);

  // Remove matches for that season
  var matches = loadMatches();
  var kept = [];
  for (var m = 0; m < matches.length; m++) {
    if (matches[m].seasonId !== selectedId) kept.push(matches[m]);
  }
  saveMatches(kept);

  // After delete, set selected season back to active
  setSelectedSeasonId(activeId);

  lastRankState = null;
  renderHistoryFromStorage();

  alert("Season deleted.");
}
  function renumberSeasonIds() {
  ensureSeasonSystem();

  var seasons = loadSeasons();
  var matches = loadMatches();

  if (!seasons || seasons.length === 0) {
    alert("No seasons found.");
    return;
  }

  if (!confirm("This will rename season IDs to S1, S2, S3... and update all matches. Continue?")) return;

  // Sort seasons by start time (oldest first)
  seasons.sort(function(a, b) {
    return Number(a.startAt || 0) - Number(b.startAt || 0);
  });

  // Build mapping oldId -> newId
  var map = {};
  for (var i = 0; i < seasons.length; i++) {
    var oldId = seasons[i].id;
    var newId = "S" + (i + 1);
    map[oldId] = newId;

    seasons[i].id = newId;

    // Default name if empty
    if (!seasons[i].name) seasons[i].name = newId;
  }

  // Update matches seasonId
  for (var m = 0; m < matches.length; m++) {
    var old = matches[m].seasonId;
    if (old && map[old]) matches[m].seasonId = map[old];
  }

  // Update active/selected IDs
  var activeOld = getActiveSeasonId();
  var selectedOld = getSelectedSeasonId();

  if (activeOld && map[activeOld]) setActiveSeasonId(map[activeOld]);
  if (selectedOld && map[selectedOld]) setSelectedSeasonId(map[selectedOld]);

  saveSeasons(seasons);
  saveMatches(matches);

  lastRankState = null;
  renderHistoryFromStorage();

  alert("Season IDs renumbered successfully.");
}
  document.addEventListener("click", function(e){
  var t = e.target;
    // Edit match button (active season)
if (t && t.getAttribute && t.getAttribute("data-edit-id")) {
  var idEdit = String(t.getAttribute("data-edit-id") || "");
  if (!idEdit) return;

  ensureSeasonSystem();
  var activeId = getActiveSeasonId();

  var matches = loadMatches();
  var found = null;
  for (var i = 0; i < matches.length; i++) {
    if (matches[i].seasonId === activeId && String(matches[i].matchId) === idEdit) {
      found = matches[i];
      break;
    }
  }

  if (!found) {
    alert("Match not found (or not in active season).");
    return;
  }

  // Fill form inputs
  document.getElementById("inPlace").value = found.place;
  document.getElementById("inKills").value = found.kills;
  document.getElementById("inAssists").value = found.assists;
  document.getElementById("inDeaths").value = found.deaths;
  document.getElementById("inMVP").checked = !!found.mvp;
  document.getElementById("inLeft").checked = !!found.left;

  editingMatchId = found.ts;

  var saveBtn = document.getElementById("saveEditBtn");
  if (saveBtn) saveBtn.style.display = "inline-block";

  // Go to ADD tab
  var btns = document.querySelectorAll(".nav-btn");
  showTab("add", btns[3]);

  return;
}

  // Delete match button
  if (t && t.classList && t.classList.contains("btn-mini") && t.classList.contains("danger") && t.getAttribute("data-ts")) {
    var ts = Number(t.getAttribute("data-ts"));
    if (!isFinite(ts)) return;

    ensureSeasonSystem();
    var activeId = getActiveSeasonId();
    
    makeBackup("before delete match");
    if (!confirm("Delete this match from the active season? This cannot be undone.")) return;

    var matches = loadMatches();
    var kept = [];
    var removed = false;

    for (var i = 0; i < matches.length; i++) {
      // Only allow deleting from active season
      if (matches[i].seasonId === activeId && Number(matches[i].ts) === ts) {
        removed = true;
        continue;
      }
      kept.push(matches[i]);
    }

    if (!removed) {
      alert("Match not found (or not in active season).");
      return;
    }

    saveMatches(kept);
    lastRankState = null;
    preloadSfx();
    renderHistoryFromStorage();
  }
});
  
  preloadRankBadges();
  // =============================


  
  // =============================
// AWARD ENGINE (Apex-style) — production
// Auto-close, no preview buttons
// =============================

function getAwardEls(){
  return {
    award: document.getElementById('award'),
    badge: document.getElementById('badge'),
    subText: document.getElementById('subText'),
    rightText: document.getElementById('rightText'),
    labelTop: document.getElementById('labelTop'),
    labelName: document.getElementById('labelName'),
    apexBannerTitle: document.getElementById("apexBannerTitle"),
  };
}

let timers = [];
function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }

// Accent fallback table (optional)
const ACCENT_BY_RANK = {
  eidolon:"#d61830",
  seraph:"#d9f9e8",
  monarch:"#c7336c",
  overlord:"#8c4826",
  archon:"#01a7ef",
  reaper:"#9bb1f6",
  harbinger:"#a6b1b9",
  marauder:"#fef525",
  thrall:"#60eb89",
  outcast:"#2b2f3a",
};

function openOverlay(mode){
  const els = getAwardEls();
  if(!els.award || !els.badge) return;

  clearTimers();
  
 // prevent double-open flicker
if (award.classList.contains('is-open')) {
  award.classList.remove('is-open');
  award.removeAttribute('data-phase');
  void award.offsetWidth; // force reflow
}

  els.award.classList.add('is-open');
  els.award.setAttribute('aria-hidden','false');

  els.award.classList.toggle('is-tierup', mode === 'tierUp');
  els.award.classList.toggle('is-rankup', mode === 'rankUp');

  // reset mode flags
  els.award.classList.remove('is-top','is-finisher','is-up','is-down');

  // ✅ CRITICAL: phase machine start
  els.award.setAttribute('data-phase','open');

  // reset badge animation
  els.badge.classList.remove('anim-up');
  void els.badge.offsetWidth;
}

function closeOverlay(){
  const els = getAwardEls();
  if(!els.award) return;

  clearTimers();

  els.award.classList.remove('is-open','is-tierup','is-rankup','is-top','is-finisher','is-up','is-down');
  els.award.removeAttribute('data-phase');
  els.award.removeAttribute('data-tier');
  els.award.setAttribute('aria-hidden','true');

  try { document.activeElement && document.activeElement.blur(); } catch(e) {}
}

function setTierClass(divIndex){
  const els = getAwardEls();
  const badge = els.badge;
  if(!badge) return;

  badge.classList.remove('tier-0','tier-1','tier-2');
  badge.classList.add(`tier-${Math.max(0, Math.min(2, divIndex))}`);
}

function setBadge(iconSrc){
  const els = getAwardEls();
  const badge = els.badge;
  if(!badge) return;

  if(iconSrc) badge.style.setProperty('--badge-url', `url("${iconSrc}")`);
}
/* =========================
   CINEMATIC AUDIO ENGINE (MP3)
   ========================= */

const SFX = {
  rankUpRiser: new Audio('assets/sounds/rank-up-riser.mp3'),
  rankUpImpact: new Audio('assets/sounds/rank-up-impact.mp3'),
  tierUp: new Audio('assets/sounds/tier-up.mp3'),
  down: new Audio('assets/sounds/down.mp3'),
};

// preload + safe defaults
Object.values(SFX).forEach(a=>{
  a.preload = 'auto';
  a.volume = 0.85;
});

// Autoplay unlock (browser policy): unlock on first user interaction
let __audioUnlocked = false;
function unlockAudioOnce(){
  if (__audioUnlocked) return;
  __audioUnlocked = true;

  // try a silent play-pause to unlock
  Object.values(SFX).forEach(a=>{
    try{
      a.muted = true;
      a.play().then(()=>{
        a.pause();
        a.currentTime = 0;
        a.muted = false;
      }).catch(()=>{ a.muted = false; });
    }catch(e){}
  });
}
document.addEventListener('pointerdown', unlockAudioOnce, { once:true });

function playSFX(name){
  const a = SFX[name];
  if(!a) return;
  try{
    a.currentTime = 0;
    a.play().catch(()=>{});
  }catch(e){}
}
  function stopSFX(name){
  const a = SFX[name];
  if(!a) return;
  try { a.pause(); a.currentTime = 0; } catch(e){}
}
  
  function formatDivisionFromLabel(toText){
  // expects "ARCHON II" or "ARCHON I"
  const parts = String(toText || "").trim().split(/\s+/);
  const tier = parts[0] ? parts[0].toUpperCase() : "";
  const div = parts[1] ? parts[1].toUpperCase() : "";
  return div ? (tier + " " + div) : tier;
}
function formatTierNameFromText(toText){
  return String(toText || "").trim().split(/\s+/)[0].toUpperCase();
}
  
function playTierUp({rankName, iconSrc, divIndex, accentColor="#01a7ef"}){
  const els = getAwardEls();
  if(!els.award || !els.badge) return;

  openOverlay('tierUp');
  els.award.classList.add('is-up');
  els.award.style.setProperty('--accent', accentColor);

  if(els.subText) els.subText.textContent = "DIVISION UPGRADED — STATUS CONFIRMED";
  if(els.rightText) els.rightText.textContent = 'AUTO';
  if(els.labelTop) els.labelTop.textContent = "DIVISION UP";
  if(els.labelName) els.labelName.textContent = rankName;
  if (els.apexBannerTitle) {
  els.apexBannerTitle.textContent = "DIVISION UPGRADED — STATUS CONFIRMED";
}

  setBadge(iconSrc);
  setTierClass(divIndex);
  els.award.dataset.tier = String(divIndex);

  els.badge.classList.add('anim-up');

  timers.push(setTimeout(()=>{ els.award.dataset.phase='impact'; playSFX('tierUp'); }, 820));
  timers.push(setTimeout(()=>{ els.award.dataset.phase='reveal'; }, 1350));
  timers.push(setTimeout(()=>{ els.award.dataset.phase='done'; }, 3000));
  timers.push(setTimeout(closeOverlay, 3000 + 2000));
}

function playTierDown({rankName, iconSrc, divIndex, accentColor="#01a7ef"}){
  const els = getAwardEls();
  if(!els.award || !els.badge) return;

  openOverlay('tierUp');
  els.award.classList.add('is-down');
  els.award.style.setProperty('--accent', accentColor);
  els.award.dataset.tier = String(divIndex);

  if(els.subText) els.subText.textContent = "DIVISION DECREASED — SYNCING";
  if(els.rightText) els.rightText.textContent = 'AUTO';
  if(els.labelTop) els.labelTop.textContent = "DIVISION DOWN";
  if(els.labelName) els.labelName.textContent = rankName;
  if (els.apexBannerTitle) {
  els.apexBannerTitle.textContent = "DIVISION DECREASED — SYNCING";
}

  setBadge(iconSrc);
  setTierClass(divIndex);

  timers.push(setTimeout(()=>{ 
  els.award.dataset.phase='impact'; 
  playSFX('down');
}, 650));
  timers.push(setTimeout(()=>{ els.award.dataset.phase='done'; }, 1500));
  timers.push(setTimeout(()=>{ els.award.classList.remove('is-down'); closeOverlay(); }, 1500 + 1400));
}

function playRankUp({rankName, iconSrc, isTop=false, accentColor="#23f3ff"}){
  const els = getAwardEls();
  if(!els.award || !els.badge) return;

  openOverlay('rankUp');
  els.award.classList.remove('is-up','is-down','is-finisher');
  els.award.classList.add('is-up');
  els.award.style.setProperty('--accent', accentColor);
  els.award.classList.toggle('is-top', !!isTop);

  // texts
  if(els.rightText) els.rightText.textContent = 'AUTO';
  if(els.apexBannerTitle) els.apexBannerTitle.textContent = "CONGRATULATIONS — NEW RANK UNLOCKED";

  if(els.labelTop) els.labelTop.textContent = 'NEW RANK';
  if(els.labelName) els.labelName.textContent = rankName;

  setBadge(iconSrc);
  setTierClass(0);

  els.badge.classList.add('anim-up');

  // audio
  playSFX('rankUpRiser');

  // phases (use setAttribute to guarantee CSS reacts)
  timers.push(setTimeout(()=>{
    els.award.setAttribute('data-phase','impact');

    playSFX('rankUpImpact');
    setTimeout(()=>stopSFX('rankUpImpact'), 420);

    // glitch exactly on impact
    els.award.classList.add('is-finisher');
    setTimeout(()=>els.award.classList.remove('is-finisher'), 500);
  }, 1050));

  timers.push(setTimeout(()=>{ els.award.setAttribute('data-phase','reveal'); }, 1300));
  timers.push(setTimeout(()=>{ els.award.setAttribute('data-phase','done'); }, 2150));

  const hold = isTop ? 3200 : 2600;

  // IMPORTANT: close only after hold
  timers.push(setTimeout(closeOverlay, 2150 + hold));
}

function playRankDown({rankName, iconSrc, accentColor="#23f3ff"}) {
  const els = getAwardEls();
  if (!els.award || !els.badge) return;

  openOverlay('rankUp'); // (можеш лишити так, або зробити окремий режим)
  els.award.dataset.phase = 'open';
  els.award.classList.add('is-down');
  els.award.style.setProperty('--accent', accentColor);

  if (els.subText) els.subText.textContent = "RANK DECREASED — UPDATING RECORD";
  if (els.rightText) els.rightText.textContent = 'AUTO';
  if (els.labelName) els.labelName.textContent = rankName;
  if (els.apexBannerTitle) els.apexBannerTitle.textContent = "RANK DECREASED";

  setBadge(iconSrc);
  setTierClass(0);

   // phases for RankDown: open -> impact -> reveal -> done
  timers.push(setTimeout(()=>{ 
    els.award.setAttribute('data-phase','impact');
    playSFX('down');                 // звук на impact
  }, 850));

  timers.push(setTimeout(()=>{ 
    els.award.setAttribute('data-phase','reveal');
  }, 1100));

  timers.push(setTimeout(()=>{ 
    els.award.setAttribute('data-phase','done');
  }, 1850));

  timers.push(setTimeout(()=>{ 
    els.award.classList.remove('is-down');
    closeOverlay();
  }, 1850 + 2000));
}


// ESC closes if open
window.addEventListener('keydown', (e)=>{
  const els = getAwardEls();
  if(e.key === 'Escape' && els.award && els.award.classList.contains('is-open')) closeOverlay();
});

  function _rankKeyFromText(t){
  return String(t || "").trim().split(" ")[0].toLowerCase();
}
function _isTopRankName(name){
  return String(name || "").toUpperCase() === "EIDOLON";
}

window.hideRankUp = function(){ closeOverlay(); };

window.showTierUp = function(payload){
  const fullLabel = String(payload?.toText || "").toUpperCase();
  const toText = payload?.toText || "";
  const rankKey = _rankKeyFromText(toText);
  const iconSrc = `assets/ranks/${rankKey}.webp`;
  const divIndex = (payload?.divIndex != null) ? Number(payload.divIndex) : 0;

  const isDown = String(payload?.rrText || "").toUpperCase().includes("DOWN");

  const accentColor =
  ACCENT_BY_RANK[rankKey] ||
  (typeof rankTiers !== "undefined" && rankTiers.find(t => t.name === rankKey.toUpperCase())?.color) ||
  "#01a7ef";

  if (isDown)
  playTierDown({ rankName: fullLabel, iconSrc, divIndex, accentColor });
else
  playTierUp({ rankName: fullLabel, iconSrc, divIndex, accentColor });
};

window.showRankUp = function(payload){
  const toText = payload?.toText || "";
  const rankKey = _rankKeyFromText(toText);
  const iconSrc = `assets/ranks/${rankKey}.webp`;

  const isTop = _isTopRankName(rankKey.toUpperCase());
  const isDown = String(payload?.rrText || "").toUpperCase().includes("DOWN");

  const accentColor =
  ACCENT_BY_RANK[rankKey] ||
  (typeof rankTiers !== "undefined" && rankTiers.find(t => t.name === rankKey.toUpperCase())?.color) ||
  "#23f3ff";

  if (isDown) playRankDown({ rankName: rankKey.toUpperCase(), iconSrc, accentColor });
  else playRankUp({ rankName: rankKey.toUpperCase(), iconSrc, isTop, accentColor });
};
  
/* ===== INIT ===== */
renderHistoryFromStorage();
</script>
  <!-- ===== END OF JAVASCRIPT ===== -->

  
<!-- ===== Award Overlay (Apex-style) ===== -->
<div id="award" aria-hidden="true">

  <div class="veil"></div>

  <!-- Apex-style top banner -->
  <div class="apexBanner" id="apexBanner" aria-hidden="true">
    <div class="apexBanner__plate">
      <div class="shimmerLine" aria-hidden="true"></div>
      <div class="apexBanner__title" id="apexBannerTitle">
        CONGRATULATIONS — NEW RANK UNLOCKED
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="left">
      <div class="kicker">RANKED UPDATE</div>
      <div class="sub" id="subText">Apex-style evolution • Confirmed.</div>
    </div>
    <div class="right" id="rightText">AUTO</div>
  </div>

  <!-- CENTER = FX + BADGE ONLY -->
  <div class="center">

    <!-- FX layers -->
    <div class="impactFlash"></div>
    <div class="coreFlash"></div>
    <div class="creationGlow"></div>
    <div class="wingWave"></div>
    <div class="sparks"></div>
    <div class="falling"></div>

    <!-- BADGE -->
    <div class="stack">
      <div class="rankBadge tier-0 animated" id="badge">
        <div class="rankBadge__img" id="rankIcon"></div>

        <div class="slice s1"></div>
        <div class="slice s2"></div>
        <div class="slice s3"></div>
        <div class="slice s4"></div>

        <span class="rankBadge__halo"></span>
      </div>
    </div>

  </div><!-- /center -->

  <!-- ✅ RANK LABEL (OUTSIDE .center) -->
  <div class="label" id="rankLabel" aria-hidden="true">
    <div class="labelTop" id="labelTop">NEW RANK</div>
    <div class="labelName" id="labelName">EIDOLON</div>
  </div>

</div><!-- /award -->
  
</div>
</body>
</html>
